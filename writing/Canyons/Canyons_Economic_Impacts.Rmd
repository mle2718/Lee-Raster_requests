---
title: "Canyons and Seamounts Economic Impacts"
author: "Min-Yang Lee"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
  word_document: default
header-includes: \usepackage{setspace}\doublespacing
urlcolor: blue
editor_options:
  chunk_output_type: console
fontsize: 12pt
bibliography: Canyons.bib
---
<!-- 
This is the markdown document used to do the Economic Impacts for The Canyons and Seamounts Omnibus.  It uses the offshoreWind package
-->
 
 
 <!---- 
 The global_options chunk loads libraries, sets options, figures out if you're on a desktop or server, sets years, and sets graphing options
 --->
```{r global_options, include=FALSE}

library("offshoreWind")
library("foreign")
library("RColorBrewer")
library("dichromat")
library("data.table")
library("lattice")
library("scales")
library("openxlsx")
library("sp")
library("rgdal")
library("raster")
library("snowfall")
library("ggplot2")
library("dplyr")
library("tidyr")
library("stringr")
library("knitr")
library("lubridate")
library("devtools")
library("RODBC")
library("googledrive")
library("googlesheets4")
library("rasterVis")
library("classInt")
library("rgeos")
library("here")
library("kableExtra")
library("tinytex")
library("viridis")
here::i_am("writing/Canyons/Canyons_Economic_Impacts.Rmd")

#############################################################################
#knitr options

knitr::opts_chunk$set(echo=FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE, cache = FALSE, progress = TRUE, verbose = FALSE, 
											dpi = 600)
options(tinytex.verbose = TRUE)
# options(knitr.table.format = "latex")

# knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'myfile.pdf')) })
#############################################################################


#############################################################################
# figure out the OS 
# Different setups based on whether you are using Windows or Not-windows
desktopUse = ifelse(unname(Sys.info()["sysname"]) == "Windows", TRUE, FALSE)


# We have set network_location_desktop and network_location_remote in  .Rprofile
  if (desktopUse) { # set the root path of the network, based on whether on desktop or server
    network_location = network_location_desktop
    system("ipconfig", intern = TRUE)
  } else {
    network_location = network_location_remote
  }




#############################################################################

#############################################################################
# versioning options
todaysdate <- Sys.Date()
todaysdate<-"2022-07-01"
#############################################################################
# Paths, names, and locations of inputs and outputs
offshoreWindpath<-file.path(network_location,"home2","mlee","offshoreWind")
project_root_path<-here()
wind_area_hard_name = "Canyons"
proj_area_name <- wind_area_hard_name 
wind_area_name <- wind_area_hard_name

raster_manifest_location<-here("raw_data")
individual.raster.file=paste0("raster_manifest_",todaysdate,".Rds")
payloadRDS=here("raw_data",individual.raster.file)

root.geotiff.path<-here("geotiffs",wind_area_hard_name)
root.image.path = here("images",wind_area_hard_name)
root.table.path = here("tables",wind_area_hard_name)

output_folder_name = here("raw_data","Canyons")
output_f = output_folder_name

output_revenue = file.path(output_f, "REVENUEFILEs")

dir.create(output_revenue, showWarnings = FALSE)
dir.create(root.geotiff.path, showWarnings=FALSE)
dir.create(root.image.path, showWarnings=FALSE)
dir.create(root.table.path, showWarnings=FALSE)
dir.create(output_folder_name, showWarnings=FALSE)

# create not in function
"%notin%" = function(x,y) (x[!x%in%y])

raw_data_path = file.path(offshoreWindpath,"data-raw")
 
# shapefile_path = file.path(network_location,"home5/dcorvi/geret_data_request/HerringFW7")
shapefile_path = "" # file path where a shapefile is to use for the map on the report
shapefile_path = here("input_data","Canyons","Northeast_Canyons_New")

# create new folder for section
dir.create(file.path(output_f, "revenuefile"), showWarnings = FALSE)
dir.create(file.path(output_f, "fin"), showWarnings = FALSE)
output_revenuefile = file.path(output_f, "revenuefile")
output_fin = file.path(output_f, "fin")


ML.GIS.PATH<-file.path(network_location,"home2", "mlee", "spatial data")

overlap_data_path = here("overlap_data",wind_area_hard_name) # the file path of the folder where the overlap files are

# RFA data
RFA_filepath<-file.path(network_location,"work5", "socialsci", "RFA_EO12866 Guidelines","ownership_data","current data and metadata","affiliates_2022_06_01.Rdata")

#############################################################################
# GIS options, you  probably shouldn't change these. 

BASE.RASTER = raster(file.path(network_location,"work5","socialsci","Geret_Rasters","Data","BASERASTER_AEA_2"))
PROJ.USE = CRS('+proj=aea +lat_1=28 +lat_2=42 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 ') 
# Albers Equal Area conic (in meters)

#############################################################################

#name and location of dmis2022 flatfile.

dmis2022_infile<-here("raw_data","APSD_WIND_TEST_2022_07_07.Rds")



#name and location of Habitat_OA2_file

AREA.PATH = file.path(network_location,"work5","socialsci","Geret_Rasters","Data","NEFMC_Coral","Trip_level_data")


START.YEAR<-2012
#START.YEAR<-2018
END.YEAR<-2020

deflate_by <- "year"
#base year and/or quarter for GDP Deflator
base_year = 2020 # base year for GDP deflator - Maximum = 2020, Minimum = 1947  - max(GDPDEF_quarterly$Year)
base_quarter = "" # base quarter for GDP deflator e.g. "Q1", "Q2" etc. Maximum = Q1 of 2020, Minimum = Q1 of 1947 - leave blank to query by year

numyear <- offshoreWind::proper(offshoreWind::numbers2words(as.integer(length(START.YEAR:END.YEAR))))

numeric_years<-as.integer(length(START.YEAR:END.YEAR))
###################################################################################################
############SETUP RASTER MAPPING AND CONFIDENTIALITY OPTIONS ######################################
###################################################################################################
  #rescale to "total [[ACTIVITY]] per square km" requires dividing by 4 because the grid cells are 0.25 km^2
  rescale_factor<-4

# Seed for subsampling
    set.seed(24601)
# Max nodes for raster confidentiality    
    max.nodes<-8
##################################

### Setting up BINNING options: 

# Number of breaks  -  for classifiying raster values into bins
nbreaks=5

# Subsample for Jenks Natural breaks classifications?  Set sampling-seed later
num_jenks_subs=5000 # Maybe this should be higher; set to 1000 for the map production process. But, the higher the sample the longer it takes to run.

# Here we exclude all cells <=1. (Later we deal with rasters with so few cells above the lower bound value,
    # that we change the sample size to match the number of cells with those values.)
jenks.lowerbound=1/rescale_factor

# Min and Max x and y values set to standardize plot extent # the plot extent is set, but then adjusted based on the location of points in the plotted region
my.ylimit=c(250000,850000)
my.xlimit=c(1900000,2450000)

#cut point options 
#my.at <- seq(10, 2500, 500) #this defines equal intervals from 10 to 2500 by 500 units.

#turn things on or or off 
myscaleopts <- list(draw=FALSE) #Don't draw axes
#myscaleopts <- list(draw=TRUE)


#brewer.friendly.ygb <- c("#ffffff", brewer.pal(nbreaks, "YlGnBu"))
#my.friendly.YGB=rasterTheme(region=brewer.friendly.ygb)

#color options (par.setting)
#mycoloropts <- c(my.friendly.YGB)
our.max.pixels=8e8

# PNG Image Size in pixel units (?) 
png.height<-1800
png.width<-1400

## land color 
mylandfill<- "#d1d1e0"
############################


# Number of color value "bins", plus 0-value will be added too.
numclasses <- 5

# Set Color Ramp Values 
#brewer.friendly.bupu <- c("#ffffff", brewer.pal(numclasses, "BuPu")) # Blue to purple  (low to high) 
#my.friendly.BUPU <- rasterTheme(region=brewer.friendly.bupu)
 
#mycoloropts <-  c(my.friendly.BUPU) 

# Other Plotting Settings 
#myckey <- list(labels=list(cex=2)) # Set the size of color ramp labels (?)
```

```{r Set_switches, eval=TRUE}


# Data_Process_Switch<-TRUE will extract and process data. This takes a while, so set to FALSE after you run the first time.
Data_Process_Switch<-FALSE
#Data_Process_Switch<-TRUE
query_dmis_table = FALSE # query old or new dmis table from Oracle? True = yes, False = use flatfile in data/
query_rec_table = FALSE # query rec table from Oracle? True = yes, False = use flatfile in data/
query_permits = TRUE # query permit ids for vtr from Oracle? True = yes, False = use flatfile in data/
query_gearids = TRUE # query gearids for dmis from Oracle? True = yes, False = use flatfile in data/

top_fmp_section = TRUE
other_fmp_section = FALSE
top_species_section = FALSE
select_species_section = FALSE
select_gear_section = TRUE
fishery_dependence_section = FALSE

select_gear_custom =TRUE

trip_and_vessel_section = FALSE

single_area_summaries = FALSE # force summary tables even if theres only one area
number_of_top_species = 10 # number of top species for top species section

selectSpecies <- c("BUTTERFISH", "SUMMER FLOUNDER", "INSHORE LONGFIN SQUID", "AMERICAN LOBSTER", "ATLANTIC MACKEREL", "OCEAN QUAHOG", "SCUP", "BLACK SEA BASS", "ILLEX SQUID") # Species in select species section

# sort(unique(SPECIES$SPPNM)) # List of species names


# set code chunks to evaluate
eval_create_connection = query_dmis_table | query_permits | query_gearids 
eval_query_DMIS_or_REC = query_dmis_table | query_rec_table 
eval_query_gearids_permits = query_gearids | query_permits 

#This is hardcoded, instead of being picked up from MGAREA
number_of_areas<-1

summary_tables = number_of_areas > 1 # create summary tables if more than 1 area - can change to false to force summaries of single areas

summary_tables <- if_else(single_area_summaries, TRUE, summary_tables) # create summary tables if forced

top_fmp_section_summary = top_fmp_section & summary_tables
other_fmp_section_summary = other_fmp_section & summary_tables
top_species_section_summary = top_species_section & summary_tables
select_species_section_summary = select_species_section & summary_tables
select_gear_section_summary = select_gear_section & summary_tables
# Setup section numbers
section_num = 0


rounded_message <- "All numbers have been rounded to the nearest thousand."
area_adjective = "" # The adjective that can be assigned before the word 'area' in the dynamic text - default is blank (e.g. "..most revenue from the areas over the five year analysis.." )


##############################
#### Set Output Variables ####
##############################

save_files = "b" # either c("r","c","b","n") r = Save RData files, c = save csv files, b = save both, n = dont save any files

project_name = "TEST"  # description text that precedes the output file names

# used for naming the folder where files will be saved

# Plot colors
assignedColors <- TRUE # assign unique colors for each margin in plots

paletteName1 <- "Accent" # which color palette to use for plots - check all available pallets with display.brewer.all()

paletteName2 <- "Set3" # which color palette to use for plots - check all available pallets with display.brewer.all()

paletteName3 <- "Paired" # which color palette to use for plots - check all available pallets with display.brewer.all()

# set maximum color number generated by palette name
maxUniqueColors <- brewer.pal.info[paletteName1, "maxcolors"]




source(here("R_code","project_logistics","R_credentials_RODBC.R"))

```	



 <!---- 
 The getcallArea chunk does the heavy lifting of figuring out which bits of rasters are inside which areas.Only run this once per project, if you can help it.
 --->
```{r getcallArea, include=FALSE, eval =FALSE}  
# This was run on July5, 2022. No need to run again unless you want to burn an hour of computing time.
    get_overlays(
      raster_folder = file.path(network_location, "work5/socialsci/Geret_Rasters/Data/individualrasters"),
      file_list_and_extents_folder = file.path(network_location, "work5/socialsci/Geret_Rasters/Data/offshore_wind_package_data/raster_extents_and_file_list"),
      projection = PROJ.USE,
      shapefile_f = here("input_data","Canyons","Northeast_Canyons_New"),
      output_f = overlap_data_path,
      start = START.YEAR,
      end = END.YEAR)
```

```{r tidy_up_speciesA, include=FALSE, eval=TRUE}

SPECIES_CUSTOM<-offshoreWind::SPECIES %>%
        mutate(FMP=replace(FMP, NESPP3 %in% c("727","711"), "American Lobster")) %>% #Lob + Jonah together 
        mutate(FMP=replace(FMP, NESPP3 %in% c("710"), "Red Crab"))%>% #Red Crab
        mutate(FMP=replace(FMP, NESPP3 %in% c("444","446"), "Tilefish")) %>%
        mutate(FMP=replace(FMP, NESPP3 %in% c("748"), "No Federal FMP"))
```




```{r readin_Coral_REVENUEFILE}
load(file.path(AREA.PATH,"DeepSeaCoralData_Aug_2018.Rdata"))
REVENUEFILE$REVENUE <- REVENUEFILE$REVENUE*as.numeric(244.4)/as.numeric(233.6)
REVENUEFILE$InsideREV <- REVENUEFILE$InsideREV*as.numeric(244.4)/as.numeric(233.6) 
  
FMP_DATA <- REVENUEFILE[which(REVENUEFILE$BROADZONE%in%c("600 m Min","Mt Desert Rock Option 2","Outer Schoodic Ridge","Maximum Area for Conservation")),]
FMP_DATA$Drop <- 1
FMP_DATA$Drop[FMP_DATA$GEARCODE%in%c('DRC','DRM','DRO','DRS','DRU','DSC','OHS','OTB','OTC','OTF','OTO','OTR','OTS','OTT','PTB','SED','SES',"DTC","DTS","TTS","MIX","OTH","SED","SES",'GNS',"LLB","GNR","GNO",'PTL',"PTF","PTC","PTS","PTW","PTH","PTO","TRP","PTE","PTX") & FMP_DATA$BROADZONE=="Maximum Area for Conservation"] <- 0

FMP_DATA$Drop[FMP_DATA$BROADZONE=="600 m Min" & FMP_DATA$GEARCODE%in%c('DRC','DRM','DRO','DRS','DRU','DSC','OHS','OTB','OTC','OTF','OTO','OTR', 'OTS','OTT','PTB','SED','SES',"DTC","DTS","TTS","MIX","OTH","SED","SES",'GNS', "LLB","GNR","GNO",'PTL',"PTF","PTC","PTS","PTW","PTH","PTO","TRP","PTE","PTX")] <- 0
  FMP_DATA$Drop[FMP_DATA$BROADZONE=="600 m Min" & FMP_DATA$NESPP3==710] <- 1
  FMP_DATA$Drop[FMP_DATA$BROADZONE%in%c("Mt Desert Rock Option 2","Outer Schoodic Ridge") & 
                 FMP_DATA$GEARCODE%in%c('DRC','DRM','DRO','DRS','DRU','DSC','OHS','OTB','OTC','OTF','OTO','OTR',
                                         'OTS','OTT','PTB','SED','SES',"DTC","DTS","TTS","MIX","OTH")] <- 0
  FMP_DATA <- FMP_DATA[which(FMP_DATA$Drop==0),]
  FMP_DATA$BROADZONE[FMP_DATA$BROADZONE%in%c("600 m Min","Mt Desert Rock Option 2","Outer Schoodic Ridge")] <- "Preferred Alternative"

Omnibus <- FMP_DATA %>%
  filter(BROADZONE=="Preferred Alternative") %>%
  select(-c(FMP,SPPNM)) %>%
  mutate(NESPP3 = replace_na(NESPP3, 0)) %>%
  mutate(NESPP3=sprintf("%03.0f",NESPP3)) %>%
  mutate(Year=as.numeric(Year)) %>%
  left_join(x = ., y = SPECIES_CUSTOM, by = "NESPP3") %>%
  group_by(Year, FMP) %>%
  summarise(
    inOMNIBUSRev=sum(InsideREV/1000000,na.rm = T),
    inOMNIBUSLand=sum(InsideLANDED/1000000,na.rm = T)) 

# There is no Red Crab in the Omnibus data in the Preferred Alternative. I was surprised about this, but I double checked and this is legit
# 
# Omnibus_T <- FMP_DATA %>%
#   filter(BROADZONE=="Preferred Alternative") %>%
#   select(-c(FMP,SPPNM)) %>%
#   mutate(NESPP3 = replace_na(NESPP3, 0)) %>%
#   mutate(NESPP3=sprintf("%03.0f",NESPP3)) %>%
#   mutate(Year=as.numeric(Year)) %>%
#   left_join(x = ., y = SPECIES_CUSTOM, by = "NESPP3")




rm(FMP_DATA)
rm(REVENUEFILE)

```

 <!---- 
 The construct raster manifest chunk constructs a dataframe of raster ids. Only run this once per project and it's only needed if you have to make maps..
 --->
```{r construct raster manifest, eval = FALSE}
#This was run on July 5, 2022. No need to run again
source(here("R_code","raster_manifest.R"))
```



 <!---- 
 The load_libraries_and_sign_in_to_Google chunk does something, but I don't know what
 --->
```{r load_libraries_and_sign_in_to_Google, eval = T}  
#------------------------------- Remember to enter a selection (1 or 0) to sign into Google in this code chunk -------------------------------# 


# During the first run the user will be prompted to complete the OAuth process by signing into a Google account through a browser and create a token for Google access
# the token will expire after a few months - when this happens, the user will get an error and have to detach and reattache (i.e. detach("package:googlesheets4", unload = TRUE) then library(googlesheets4)) the package and should enter 0 when prompted for selection.
# Gsheet_BOEM_lease_area_table_id = "14MdREhJYjORPkb57n6NYEBSEVxeW3_Studsp0dB8KWc" # this is the id of the google sheet. Find the id of a Googe Sheet using googledrive::drive_find("BOEM Lease Area Table") %>% pull(id)

# Project_Areas_12_3_2019_id = "17auz32s3BYk7K30gT45yUCTQ_hnp_s0i" # Google ID of zip of area shapefiles

```



 <!---- 
 The LOAD_EXISTING_GIS_DATA loads shapefiles into memory and does some minimal processing on them. 
 --->
```{r LOAD_EXISTING_GIS_DATA, include=FALSE, eval=T}

##############################################
## SECTION 4 - LOAD EXISTING GIS DATA
#################################################


# STATISTICAL AREAS
my_basemap1 = readOGR(dsn=file.path(ML.GIS.PATH,"nmfs spatial data","corrected_stat_areas"), layer="Statistical_Areas", verbose=F)
my_basemap1 = spTransform(my_basemap1, CRS=PROJ.USE)# Don't project if you're plotting in a lat/lon, not-projected CRS

# Establish "the other"lat lon" projection info
PROJ.LATLON = crs(my_basemap1)

#THIRTY MINUTE SQUARES
#basemap_30min = readOGR(dsn=file.path(ML.GIS.PATH,"nmfs spatial data", "Thirty_Minute_Squares"), layer="Thirty_Minute_Squares", verbose=F)
#basemap_30min = spTransform(basemap_30min, CRS=PROJ.USE) # Don't project if you're plotting in a lat/lon, not-projected CRS

# EastCoast_states
basemap_eastcoast = readOGR(dsn=file.path(ML.GIS.PATH,"basic spatial data","more_states"), layer="EastCoast_states", verbose=F)
basemap_eastcoast = spTransform(basemap_eastcoast, CRS=PROJ.USE) # Don't project if you're plotting in a lat/lon, not-projected CRS

# EEZ Shapefiles
#basemap_EEZ = readOGR(dsn=file.path(ML.GIS.PATH,"nmfs spatial data", "corrected_stat_areas", "EEZ"), layer="EEZ", verbose=F)
#basemap_EEZ = spTransform(basemap_EEZ, CRS=PROJ.USE) # Don't project if you're plotting in a lat/lon, not-projected CRS

# Herring Management areas
#basemap_herringHMA = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures", "garfo gis", "Herring_Management_Areas"), layer="Herring_Management_Areas_mod", verbose=F)
#basemap_herringHMA = spTransform(basemap_herringHMA, CRS=PROJ.USE)


#Multispecies Closed Areas CAI, CAII, NLS)
# CAI_grnd = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures","multispecies closed areas"), layer="mults_ca1", verbose=F)
# CAI_grnd = spTransform(CAI_grnd, CRS=PROJ.USE)
# CAI_grnd = CAI_grnd[CAI_grnd$id==2,]
# 
# CAII_grnd = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures","multispecies closed areas"), layer="mults_ca2", verbose=F)
# CAII_grnd = spTransform(CAII_grnd, CRS=PROJ.USE)
# 
# NLS_grnd = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures","multispecies closed areas"), layer="mults_nls", verbose=F)
# NLS_grnd = spTransform(NLS_grnd, CRS=PROJ.USE)
# 
# Closedgf_04_15 = gUnion(CAI_grnd[CAI_grnd$id==2,],CAII_grnd)
# Closedgf_04_15 = gUnion(Closedgf_04_15,NLS_grnd)


# Read in Canyons
Canyons_full = readOGR(dsn=here("input_data","Canyons","Northeast_Canyons"), layer="Northeast_Canyons_and_Seamounts_Marine_National_Monument", verbose=F)
Canyons_full = spTransform(Canyons_full, CRS=PROJ.USE)


# Read in Omnibus Habitat
Omnibus_Habitat = readOGR(dsn=here("input_data","Canyons","Omnibus_Habitat"), layer="Omnibus_Deep_Sea_Coral_Amendment", verbose=F)
Omnibus_Habitat = spTransform(Omnibus_Habitat, CRS=PROJ.USE)

# Read in the marginal (new) Canyons area
Canyons_new = readOGR(dsn=here("input_data","Canyons","Northeast_Canyons_New"), layer="Northeast_Canyons_and_Seamounts_new", verbose=F)
Canyons_new = spTransform(Canyons_new, CRS=PROJ.USE)


```


 <!---- 
 The data_process_Canyons knits a child RMD.  There are a bunch of 'options' that were originally set in these chunks. I've moved most of them to the global_options and set_switches sections. but not all of them. And some are hard coded. 
 
 This only works when you knit, not when you run a chunk.
 --->

```{r child=here("writing","Canyons", "data_process_Canyons.Rmd"), eval=Data_Process_Switch}
```




```{r load_REVENUEFILE_and_FIN, eval = TRUE} 
START.YEAR<-2012
#START.YEAR<-2018
END.YEAR<-2016

REVENUEFILE<-readRDS(file.path(output_revenue, paste0("REVENUEFILE_", proj_area_name, ".Rds")))
REVENUEFILE <-REVENUEFILE %>%
  filter(Year>=START.YEAR & Year<=END.YEAR) %>%
  mutate(Area = if_else(Area=="Northeast_Canyons_And_Seamounts", "Northeast_Canyons_And_Seamounts_Addition", Area))

numyear <- offshoreWind::proper(offshoreWind::numbers2words(as.integer(length(unique(REVENUEFILE$Year)))))


FIN<-readRDS(file.path(output_fin, paste0("FIN_", proj_area_name, ".Rds"))) 


SCOQ_swap <-FIN %>%
  filter(FMP=="Surfclam, Ocean Quahog") %>%
  rename(YEAR=Year) %>%
  group_by(FMP, YEAR) %>%
  summarise(VALUE=sum(REVENUE/1000000,na.rm = T),
            LANDINGS=sum(QTYKEPT/1000000,na.rm = T),
            nominal_revenue=sum(nominal_revenue/1000000,na.rm = T))
  
FIN <-FIN %>%
  filter(Year>=START.YEAR & Year<=END.YEAR)

 allZones1 <- sort(unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]) 
# as.factor(unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ])
allZones <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", allZones1), perl=TRUE) # make name pretty

CFDBS_FMP<-readRDS(file= file.path(output_revenue, paste0("CFDBS_FMP.Rds")))
# Drop the clam/quahog from CFDBS_FMP and substitute in the totals from FIN

CFDBS_FMP <-CFDBS_FMP %>%
  filter(FMP!="Surfclam, Ocean Quahog")%>%
  bind_rows(SCOQ_swap) %>%
  left_join(Omnibus, by=c("FMP"="FMP", "YEAR"="Year")) %>%
  filter(YEAR>=2012 & YEAR<=2020) %>%
  mutate(inOMNIBUSLand = ifelse(is.na(inOMNIBUSLand), 0, inOMNIBUSLand),
         inOMNIBUSRev = ifelse(is.na(inOMNIBUSRev), 0, inOMNIBUSRev),
         )
# Not red crab, is this a parsing problem with species names?




```

<!-- Note: The HULLNUM/VESID variable is not used in this dataset to fill in the permit number for clam trips (which don't have a permit attached to the record in the SFCLAM database). This will introduce NA's to the data. -->

 <!----  The create_map_of_lease_area chunk makes a map of the area of the ocean --->
```{r create_map_of_lease_area, eval = T,fig.cap="\\label{fig:map_NCSMNM}Northeast Canyons and Seamounts National Monument Addition.  This area is part of the NCSMNM that does not lie inside the Georges Bank Deep Sea Coral Area."} 
  crs <- CRS("+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

if (any(proj_area_name %in% formatted_lease_area_table$proj_area_file_name)) {
  
all_areas <- spTransform(offshoreWind::all_areas, CRS=crs)
all_areas <- sf::st_as_sf(all_areas)

lease_area <- all_areas %>% dplyr::filter(NAME == proj_area_name)

states <- map_data("state")
east_coast <- subset(states, region %in% c("maine", "massachusetts", "vermont", "new hampshire","rhode island", "connecticut", "new york", "pennsylvania", 
                                           "new jersey", "maryland", "delaware", "district of columbia", "virginia", "west virginia", "north carolina"))
# Wind area extent
xlim <- c(-78, -70)
ylim <- c(36, 42)

lease_area_map <- ggplot(data = east_coast) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill = "#D1D1E0", color = "black") +
  geom_sf(data = lease_area, fill= "red", color = "red") +
  coord_sf(xlim = xlim, ylim = ylim) +
  ggtitle(wind_area_name) +
  theme(axis.title.y=element_blank(),
        axis.title.x=element_blank(),
        plot.title = element_text(hjust = 0.5))

}

if (any(proj_area_name %in% formatted_lease_area_table$proj_area_file_name) == FALSE & shapefile_path != "") {
  layer_name = unique(gsub(pattern="(.+)(.shp$)","\\1", ignore.case = TRUE , list.files(path=shapefile_path, pattern = "(.+)(.shp$)", ignore.case =TRUE, recursive=F, full.names=F)))
  
  if (length(layer_name)>1) {
  
  file_list <- list.files(shapefile_path, pattern = "*shp$", full.names = TRUE)
  shapefile_list <- lapply(file_list, sf::read_sf)
  # all_areas <- do.call(rbind, shapefile_list)
  all_areas <- sf::st_as_sf(data.table::rbindlist(shapefile_list))
  all_areas <- all_areas[,(names(all_areas) %in% c("Name"))]

  #I don't understand the reason for the previous 5 lines of code that define all_areas
  count <- 0
  rm(all_areas)
  for (layer in layer_name) {
    if (count == 0) {
      all_areas <- rgdal::readOGR(dsn=shapefile_path, layer=layer, verbose=F)
      all_areas <- spTransform(all_areas, CRSobj = crs)
      all_areas@data$NAME <- layer[1]
      all_areas <- all_areas[,(names(all_areas) %in% c("NAME"))]
      all_areas
      count <- count + 1
    } else {
      extra_layer <- rgdal::readOGR(dsn=shapefile_path, layer=layer, verbose=F)
      extra_layer <- spTransform(extra_layer, CRSobj = crs)
      extra_layer@data$NAME <- layer[1]
      extra_layer <- extra_layer[,(names(extra_layer) %in% c("NAME"))]
      extra_layer
      # lease_area <- raster::aggregate(ab, dissolve = TRUE)
      all_areas <- raster::union(extra_layer, all_areas) # Combine all lease areas plus maine area into one shapefile
      rm(extra_layer)
    }
  }
  
  } else {
    all_areas <- rgdal::readOGR(dsn=shapefile_path, layer=layer_name, verbose=F)
  }
  
  all_areas <- spTransform(all_areas, CRS=crs)
  lease_area <- sf::st_as_sf(all_areas)
  
  states <- map_data("state")
  east_coast <- subset(states, region %in% c("maine", "massachusetts", "vermont", "new hampshire","rhode island", "connecticut", "new york", "pennsylvania", 
                                             "new jersey", "maryland", "delaware", "district of columbia", "virginia", "west virginia", "north carolina"))
  
  # get extents of shapefile
  xmin <- extent(lease_area)[1]
  xmax <- extent(lease_area)[2]
  ymin <- extent(lease_area)[3]
  ymax <- extent(lease_area)[4]
  
  # Create custom extent if shape is outside (north or east) of wind areas
  if (xmax > -71) {
    new_xmax <- xmax + 3 # fix extent if shape is further out east
    new_xmin <- new_xmax - 8 
    xlim <- c(new_xmin, new_xmax)
  } else {
    xlim <- c(-78, -70)
  }
  
  if (ymax > 41) {
    new_ymax <- ymax + 3 # fix extent if shape is further north
    new_ymin <- new_ymax - 6
    ylim <- c(new_ymin, new_ymax)
  } else {
    ylim <- c(36, 42)
  }
  
  #Custom extent for canyons and monuments.
 if (wind_area_hard_name == "Canyons"){
    new_ymax <- 43 
    new_ymin <- 38
    ylim <- c(new_ymin, new_ymax)
    
    new_xmax <- -66 
    new_xmin <- -74
    xlim <- c(new_xmin, new_xmax)
  } 
  
  lease_area_map <- ggplot(data = east_coast) + 
    geom_polygon(aes(x = long, y = lat, group = group), fill = "#D1D1E0", color = "black") +
    geom_sf(data = lease_area,  fill = c("#990000") )+
    coord_sf(xlim = xlim, ylim = ylim) +
#    ggtitle(wind_area_name) +
    theme(axis.title.y=element_blank(),
          axis.title.x=element_blank(),
          plot.title = element_text(hjust = 0.5))
}

plot(lease_area_map)


```

# Summary (do not include)
GARFO is leading an omnibus amendment to the Fishery Management Plans of the MA and NE Fishery Management Councils.  The proposed action would  affect vessels that hold a permit for any of the thirteen fishery management plans or for the American Lobster and Jonah Crab fisheries.  The proposed action would implement regulations to prohibit commercial fishing activities in the Northeast Canyons and Seamounts National Monument; Red crab and American lobster commercial fishing would be exempt until September 15, 2023. Recreational fishing activities are not affected.  

Commercial fishing, except for red crab and lobster, in the Northeast Canyons and Seamounts National Monument (NCSMNM) was prohibited from September 15, 2016 to June 5, 2020 (Presidential Proclamation 9496).  From June 6, 2020 to October 8, 2021, commercial fishing was allowed (Proclamation 10049).   The entirety of the NCSMNM is currently closed to fishing by Presidential Proclamation 10287 under the Antiquities Act.  82% of the NCSMNM is within the Georges Bank Deep Sea Coral Area through the NEFMC's Habitat Omnibus Amendment 2 and commercial fishing except red crab has been closed since July 26, 2021.  18% of the NCSMNM is not contained in the Georges Bank Deep Sea Coral Area is the focus of the economic analysis and is referred to as the "NCSMNM Addition" (Figure \ref{fig:map_NCSMNM}). 


\clearpage


\setcounter{section}{4}
\setcounter{subsection}{1}
\setcounter{figure}{3}
\setcounter{table}{32}


## Economic and Social Effects

### Economic Effects{#Econ-Effects}

The proposed action would close the entirety of the NCSMNM to commercial fishing. Commercial fishing for red crab and American Lobster can continue until September 15, 2023.  82% of the NCSMNM lies within the Georges Bank Deep-Sea Coral Protection Area, where commercial fishing, except with red crab pots, is currently prohibited.  

Therefore, the economic analysis focuses on the 18% of NCSMNM that is not contained with the Georges Bank Deep-Sea Coral Protection Area.  The analysis also focuses on the long-run and examines the continued closure of the NCSMNM to all gears, including Red Crab and Lobster gear.

#### Baseline Description - the Fishery {#Baseline_Description_Fishery}

A reasonable baseline is the *status quo* condition.  82% of the NCSMNM is contained within the Georges Bank Deep-Sea Coral Protection Area and fishing with all gear except red crab pot/trap gear continues to be prohibited in this area in the baseline.  Landings and revenue from recent years are used to describe the baseline economic conditions.  The Georges Bank Deep-Sea Coral Area has been closed since July 26, 2021, so data from recent years (when fishing *was* permitted the Deep-Sea Coral area) may not give the full picture of the baseline conditions.  Therefore, in addition to summarizing the average landings and revenue, by FMP in Table \ref{tab:baseline_revenues}, the average revenue derived from  the Georges Bank Deep-Sea Coral Protection Area is also presented in column four of Table \ref{tab:baseline_revenues}.  It is likely that a large proportion of the fishing activity in column four has migrated to a different part of the ocean.  All dollars and are normalized to  `r base_year` real values, using the GDP Deflator.
```{r baseline_revenues}
Baseline_rev <- CFDBS_FMP %>%
  filter(YEAR>=2017 & YEAR<=2020) %>%
  filter(FMP!="Atlantic Salmon") %>%
  group_by(FMP) %>%
  summarise(Landings=mean(LANDINGS),
            Revenue=mean(VALUE),
            `Revenue Inside GB Deep-Sea Coral`=mean(inOMNIBUSRev)) %>%
  arrange(desc(Revenue))  %>%
  bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total")))%>%
  mutate(Revenue = as.character(round(Revenue,1)) ) %>%
  mutate(Landings = as.character(round(Landings,1)) ) %>%
  mutate(`Revenue Inside GB Deep-Sea Coral`= as.character(round(`Revenue Inside GB Deep-Sea Coral`,2)) ) #%>%
  #mutate(Revenue = ifelse(FMP == "Red Crab", '(C)',Revenue))%>%
  #mutate(Revenue = ifelse(FMP == "Tilefish", '(C)',Revenue)) %>%
  #mutate(`Revenue Inside GB Deep-Sea Coral` = ifelse(FMP == "Tilefish", '(C)',`Revenue Inside GB Deep-Sea Coral`)) %>%
  #mutate(`Revenue Inside GB Deep-Sea Coral` = ifelse(FMP == "Red Crab", '(C)',`Revenue Inside GB Deep-Sea Coral`))


kbl(Baseline_rev, booktabs=T,  align=c("l",rep('r',times=4)), format.args=list(big.mark=','), digits=3, caption = "Baseline Annual Regional Landings (millions of pounds) and Value (Millions of Real 2020 USD) are derived from average 2017-2020 dealer reports.  Revenue derived from the GB Deep Sea Coral Protection Area during this time period is also presented to illustrate the magnitude of fishing that occured in this area that is currently closed to commercial fishing.")  %>%
      kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE) %>%
      row_spec(nrow(Baseline_rev),bold=T)

```


```{r GB_DSC, out.width = "40%", fig.show='hold',fig.align="center", fig.cap="\\label{fig:GB_Deep_Sea_Coral} Revenue in real 2020 USD (left) and percentage terms (right) , by FMP, derived from the Georges Bank Deep-Sea Coral Protection Area.", eval=FALSE}
knitr::include_graphics(here("writing","Canyons",c("revenue_GBCoral.png","pct_revenue_GBCoral.png")))
```


Under the *status quo* baseline, commercial fishing in the 18% of the NCSMNM not contained within the Georges Bank Deep-Sea Coral Protection Area is prohibited by Presidential Proclamation under the Antiquities Act.  As seen from historical record, the types of allowed activities in the area can easily be changed by presidential proclamation to include or not include commercial fishing.  It is therefore reasonable to infer that a future administration may prefer to allow commercial fishing in the NCSMNM and consider the economic effects of this as part of the baseline. 

If commercial fishing is allowed inside NCSMNM, additional benefits would accrue to the fishing industry.  These would be positively related to the amount of fishing that would occur in 18% of NCSMNM.  We are unable to estimate producer surplus measures associated with fishing inside this area; we therefore characterize the revenue from fishing that would occur inside this area. We use commercial fishing data from  `r START.YEAR` - `r END.YEAR` time due to the changing status of fishing inside the NCSMNM after `r END.YEAR`. 

<!---
Under the *status quo* baseline, the coral, sponges, and other underwater fauna are to be protected from impacts of commercial fishing gear by Presidential Proclamation under the Antiquities Act.  These unique attributes continue to provide non-use economic benefits (bequest and existence) as described in the statement of market failure (Section \ref{market_failure}); however, there are no benefits related to direct commercial extraction inside NCSMNM.  Finally, the habitat itself will regenerate and likely improve in quality after the cessation of fishing activities, increasing some non-use economic benefits in the future. 

If commercial fishing is allowed inside NCSMNM, the extractive and non-extractive flow of benefits will change.  Additional benefits would accrue to both the fishing industry and consumers of seafood.  These would be positively related to the amount of fishing that would occur in 18% of NCSMNM.  We are unable to estimate producer or consumer surplus measures associated with fishing inside this area; we therefore characterize the revenue from fishing that would occur inside this area. We use commercial fishing data from  `r START.YEAR` - `r END.YEAR` time due to the changing status of fishing after `r END.YEAR`. All dollars and are normalized to  `r base_year` real values, using the GDP Deflator.


If commercial fishing is allowed, the quality of habitat inside NCSMNM would decline in proportion to the increase in fishing effort.  Different types of gear have different effects on the bottom.  Both the decrease in quality of the habitat stock and the economic costs that decline in quality are difficult to quantify.  In Oceanographer, Gilbert, and Lydonia canyons, the hard canyon walls provide habitats for sponges, corals, and other invertebrates that filter food from the water to flourish, and for larger species including squid, octopus, skates, flounders, and crabs. Major oceanographic features, such as currents, temperature gradients, eddies, and fronts, occur on a large scale and influence the distribution patterns of such highly migratory oceanic species as tuna, billfish, and sharks. They provide feeding grounds for these and many other marine species.  

Some types of gear (say midwater trawl or handline) has minimal effects on the ocean bottom compared to others (say Trawl or Dredge). Table \ref{tab:revenue_table_by_gear} describes the economic activity, disaggregated by gear, projected to occur inside the NCSMNM addition if reopened. These proved insight into both the effects of fishing effort on the sea bottom and the types of commercial users that may benefit from the opening of the NCSMNM.

--->

We project the gross revenues and landings that would occur inside the NCSMNM addition area.  We use commercial fishing data based on vessel trip reports from  `r START.YEAR` - `r END.YEAR` time make this characterization. This time period is selected because the changing status of fishing makes data after `r END.YEAR` less useful for characterizing fishing activity if the NCSMNM were reopened.   These projected landings and revenues were constructed using the methods described in [@DePiper2014; @Benjamin2018] and were also used in a he similar analysis in support of the NEFMC's Habitat Omnibus Amendment 2 [-@NEFMC_habitat_2016_V6]. In brief, fishing vessels report the location (latitude and longitude) where the majority of their fishing effort was located. Fishing activity does not actually occur at a single point in the ocean.  A model, based on data collected through the observer program is used to account for this by allocating the fishing activity over a more realistic area. The amount of allocated effort that occurs inside the NCSMNM addition over the `r START.YEAR` to `r END.YEAR` period is used to construct projected revenues and landings that would occur if the NCSMNM addition was reopened to commercial fishing.

These projections *under-estimate* fishing activity attributable to the lobster fishery and pot/trap gears because vessel operators that hold a lobster permit and no other federal permit are not required to fill out vessel trip reports.  Of the 113 fishing vessels with an Area 3 lobster permit in 2018, 90 were required to file VTRs because they held other Northeast Region permits.

Table \ref{tab:top_fmp_revenue_table} projects landings and revenue that is likely to occur inside the NCSMNM addition if reopened.   These tables provide insight into likely annual flows of benefits of resuming fishing in the NCSMNM addition and the types of firms to which those benefits would accrue *in the baseline*. Figures \ref{fig:top_fmp_landings_plots} and \ref{fig:top_fmp_revenue_figure}  describe landings and  landings from `r START.YEAR` - `r END.YEAR` that occurred within the NCSMNM boundary addition disaggregated by FMP and year.  These provide insight into the likely year-to-year variation of those benefits.

To convert the annual flow of uncertain future economic activity in Tables \ref{tab:top_fmp_revenue_table} and \ref{tab:revenue_table_by_gear} into  current values, it is necessary to adjust for both the probability that fishing will occur and when it will occur.  We refrain from an assessment of either of these figures, but note that both factors will reduce the values shown in in Tables \ref{tab:top_fmp_revenue_table} and \ref{tab:revenue_table_by_gear}.


```{r fmp_top_five_dynamic_text, eval = T} 
# sort(names(REVENUEFILE))

# unique(REVENUEFILE$FMP)
# unique(REVENUEFILE$NESPP3)
# test <- REVENUEFILE %>% filter(is.na(FMP))

# Top 5 fmps after pii fix for all areas
top_five_fmp_names <- REVENUEFILE %>%
  filter(Area != "Other") %>%
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP"))%>%
  dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>%
  group_by(Year, FMP, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'Other NER', FMP)) %>%
  mutate(FMP_CONF = ifelse(FMP_CONF=="Tilefish", 'Other NER', FMP_CONF)) %>%
  ungroup() %>%
  group_by(Year, FMP_CONF, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF) %>% 
  dplyr::select(FMP, Year, Area, yfa_rev, yfa_land) %>% 
  # group_by(FMP, Area) %>% 
  group_by(FMP) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)) %>% 
  arrange(desc(allyrtotal_rev)) %>% 
  ungroup() %>% 
  top_n(n=5, wt=allyrtotal_rev) %>% 
  pull(FMP)

# Might be an issue of top 5 FMP has 0 revenue

if (any(top_five_fmp_names %in% "No Federal FMP")) {
  topfmp_names <- paste0(top_five_fmp_names[!top_five_fmp_names %in% "No Federal FMP"], collapse = ", ")
  topfmp_names <- paste0(topfmp_names, " and No Federal FMP")
} else {
  topfmp_names <- paste0(top_five_fmp_names %notin%  tail(top_five_fmp_names, n=1), collapse = ", ")
  topfmp_names <-paste0(topfmp_names, " and ", tail(top_five_fmp_names, n=1))
}

# length(unique(REVENUEFILE[which(REVENUEFILE$FMP == "None" & REVENUEFILE$InsideREV > 0),]$SPPNM))

piifmpsppnm_allyrs <- REVENUEFILE %>% 
  filter(Area != "Other") %>% 
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP"))%>%
  # dplyr::select(FMP, SPPNM, Year, InsideREV, InsideLANDED, PERMIT) %>%
  dplyr::select(FMP, SPPNM, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
  mutate( FMP=ifelse(FMP %in%top_five_fmp_names, FMP, "Other NER")) %>%
  group_by(FMP, SPPNM) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'Other NER', FMP)) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'Other NER', SPPNM)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("FMP")) %>%
  dplyr::select(InsideREV, InsideLANDED,npermits, FMP_CONF, SPPNM_CONF) %>%
  group_by(FMP_CONF, SPPNM_CONF) %>%
  dplyr::summarize(
    InsideREV_total = sum(InsideREV, na.rm = T),
    InsideLANDED_total = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>%
  arrange(desc( InsideREV_total)) %>%
  dplyr::rename("FMP"= FMP_CONF,"SPPNM"= SPPNM_CONF, "All Year Revenue" = InsideREV_total, "All Year Landings (Pounds)" = InsideLANDED_total)
  
numsp <- length(unique(piifmpsppnm_allyrs$SPPNM))


# -if areas dont have same top FMP ??


```

```{r dataprocess_landing_plots, eval=top_fmp_section}

##########################################################################

# create new folder for section
dir.create(file.path(output_f, "topfmp"), showWarnings = FALSE)
output_ftopfmp = file.path(output_f, "topfmp")


# DO NOT USE THIS TABLE FOR ANYTHING OTHER THAN DETERMINING THE NAMES OF THE TOP FMPS FOR THE AREA(S) - GROUPING FOR PII WILL MESS UP TOTALS 
# Get top revenue FMPs, sorted by revenue, grouped by FMPs for all years and remove PII - ** this list order will be used for all areas
allYearsSum <- REVENUEFILE %>% # FMP NAs are already removed in the DMIS cleaning code chunk
  filter(Area != "Other") %>% 
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP"))%>%
  # dplyr::select(FMP, InsideREV, InsideLANDED, PERMIT) %>%
  dplyr::select(FMP, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
  group_by(FMP) %>% # Using only FMP as grouping will mess up uniqueness of dealers and permits
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF = npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF = npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'Other NER', FMP)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("FMP")) %>%
  dplyr::select(InsideREV, InsideLANDED, npermits, FMP_CONF) %>%
  group_by(FMP_CONF) %>%
  dplyr::summarize(
    InsideREV_total = sum(InsideREV, na.rm = T),
    InsideLANDED_total = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF)


# PII fixed for all areas
piifmp <- REVENUEFILE %>%
 filter(Area != "Other")  %>%
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP"))%>%

  # dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(FMP, Year, InsideREV, InsideLANDED, REVENUE, QTYKEPT,PERMIT, Area, DEALNUM) %>% # for dealers
  mutate(FMP=ifelse(FMP %in% top_five_fmp_names, FMP, 'Other NER')) %>%
  group_by(Year, FMP, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'Other NER', FMP)) %>%
  mutate(FMP_CONF = ifelse(FMP_CONF=="Tilefish", 'Other NER', FMP_CONF)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("FMP")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, FMP_CONF) %>%
  group_by(Year, Area, FMP_CONF) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF)


fmpallyr_total <- piifmp %>% dplyr::select(FMP, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(FMP, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

fmp_merge <- merge(piifmp, fmpallyr_total, by = c("FMP", "Area"))

# write.csv(fmp_merge, file="fmp_merge.csv", row.names=FALSE)
# create a table with a bunch of differently grouped totals that will be filtered by area during the iteration of the graphs
topFMP_all_areas <- left_join(allYearsSum, fmp_merge, by='FMP') %>% 
  filter(FMP %in% top_five_fmp_names) # top_five_fmp_names is from the summary creater section 


# get top fmps by revenue, overall
top5fmps <- fmp_merge %>% group_by(FMP) %>%
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP"))%>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  top_n(., n=5, wt=REV) %>% 
  arrange(desc(REV)) %>% 
  ungroup
  # ungroup %>% 
  # mutate(FMP = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(FMP), perl=TRUE)) %>% 
  # mutate(FMP = if_else(FMP=="None","No Federal FMP", FMP))

topfmp_names_wrapped <- str_wrap(unique(top5fmps$FMP), width=30) # change extra long legend names - add a \n to halfway word to match plot

NumUniqueMargins <- length(unique(top5fmps$FMP))

UniqueMargins <- str_wrap(unique(top5fmps$FMP), width=30) # change extra long legend names - add a \n to halfway word to match plot

# make extra colors if more unique FMPs than maximum colors for palette
if (NumUniqueMargins > maxUniqueColors) {
  getPalette = colorRampPalette(brewer.pal(maxUniqueColors, paletteName1))
  myColors <- getPalette(NumUniqueMargins)
} else {
  myColors <- brewer.pal(NumUniqueMargins, paletteName1) # create list of colors using number of unique FMPs from pallettte name
  }

names(myColors) <- UniqueMargins # name colors for color scale

# create custom color scale assigned to each fmp to use on all top fmp plots
uniquefmpScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))

topfmpColors <- myColors

rm(NumUniqueMargins, UniqueMargins) # garbage collection

# uniquefmpScale <- make_color_scale(top5fmps$FMP, scale_name = paletteName1, maxUniqueColors = maxUniqueColors, wrap_names = TRUE)

# original color scale based on revenue quanities - subjective to areas
quantScale <- scale_fill_viridis(discrete=TRUE)

#####################################
#### Set Top FMP Plot Colors end ####
#####################################


###########################################################
############ get only data for select area ###########
###########################################################
# ### replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)

# topFMP <- left_join(head(allYearsSum[order(-allYearsSum$InsideREV_total),],5), fmp_merge, by='FMP')

#### get rev and landing plots and tables for all zones
broadzone<-allZones[1]


  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area 
  
# filter grouped totals table by the current area
topFMP_table <- topFMP_all_areas %>% filter(Area == broadzone_underscore)#create top fmp table without line breaks

#Not sure why we're filling in END.YEAR. Hope its okay.
#This only works if length()==0 or ==1. It will break for length()>=2
if (length(top_five_fmp_names %notin% unique(topFMP_table$FMP)) > 0) { # add a blank row for any missing FMPs so they appear in tables and plots for all areas
  topFMP_table[nrow(topFMP_table)+1,] <- list(top_five_fmp_names %notin% unique(topFMP_table$FMP), 0, 0, 0, broadzone_underscore, as.character(END.YEAR), 0, 0, 0, 0, 0)
}
         


topFMP <- topFMP_table
# change extra long legend names - add a \n to halfway word 
topFMP$FMP <- str_wrap(topFMP$FMP, width=30)

topFMP$FMP <- reorder(topFMP$FMP, topFMP$yfa_rev)
topFMP$FMP <- factor(topFMP$FMP, levels=levels(topFMP$FMP))
```




```{r top_fmp_landings_table, eval = top_fmp_section} 

# sort by landings
allyrland_table <- topFMP_table %>%
  distinct(FMP, allyrtotal_rev, allyrtotal_land) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(FMP, allyrtotal_land) %>%
  mutate( FMP=ifelse(FMP %in%top_five_fmp_names, FMP, "Other NER")) %>%
  group_by(FMP) %>%
  summarize(allyrtotal_land=sum(allyrtotal_land)) %>%
  mutate(allyrtotal_land=allyrtotal_land/numeric_years) %>%
  arrange(desc(allyrtotal_land)) %>%
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  ungroup()
  
# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$FMP <- as.character(allyrland_table$FMP)
allyrland_table <- rbind(allyrland_table, c("Total", colSums(allyrland_table[,2])))
# allyrland_table$`All Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500

# set dynamic varible names (cant use paste0 in rename in tidyverse)

lobster<-allyrland_table %>%
  filter(FMP=="American Lobster")
lobster_lbs<-lobster$"All Year Total"


Other<-allyrland_table %>%
  filter(FMP=="Other NER")
other_lbs<-Other$"All Year Total"

# allyrland_table %>% rename_at()

# names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Total")
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- "Average Projected Landings"

#kbl(allyrland_table, booktabs=T,  align=c("l",rep('r',times=1)), caption = "Projected Commercial landings (Pounds) that would occur in the NCSMNM addition if it was reopened to fishing based on 2012-2016 Years.")  %>%
#      kable_styling(full_width = F) %>% 
#      row_spec(0,bold=TRUE)  %>%
#      row_spec(nrow(allyrland_table),bold=T)
```

```{r top_fmp_revenue_table,  eval = top_fmp_section} 

# names(topFMP)
# create 5 year (all years) table
allyrrev_table <- topFMP_table %>% distinct(FMP, allyrtotal_rev) %>%
  mutate( FMP=ifelse(FMP %in%top_five_fmp_names, FMP, "Other NER")) %>%
  group_by(FMP) %>%
  summarize(allyrtotal_rev=sum(allyrtotal_rev)) %>%
  mutate(allyrtotal_rev=allyrtotal_rev/numeric_years) %>%
  arrange(desc(allyrtotal_rev)) %>%
  dplyr::rename("All Year Revenue" = allyrtotal_rev) %>% 
  ungroup()
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))

# convert fmp back to charaters - add totals row - format revenue column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$FMP <- as.character(allyrrev_table$FMP)
allyrrev_table <- rbind(allyrrev_table, c("Total", colSums(allyrrev_table[,2])))
# allyrrev_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyrrev_table$`All Year Revenue`))
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500


lobster<-allyrrev_table %>%
  filter(FMP=="American Lobster")
lobster_rev<-lobster$"All Year Revenue"

Other<-allyrrev_table %>%
  filter(FMP=="Other NER")
other_rev<-Other$"All Year Revenue"


allyrrev_table <-allyrrev_table %>%
  left_join(allyrland_table, by="FMP") %>%
  relocate(`All Year Revenue`, .after=last_col()) %>%
  rename(`Average Projected Revenue`=`All Year Revenue`)

# set dynamic varible names (cant use paste0 in rename in tidyverse)
#names(allyrrev_table)[names(allyrrev_table) == "All Year Revenue"] <- paste0("Average Projected Revenue")


kbl(allyrrev_table, booktabs=T,  align=c("l",rep('r',times=2)), caption = "Projected annual commercial landings (pounds) and revenue  (Real USD) that would occur in the NCSMNM addition if it was reopened to fishing based on 2012-2016 patterns of fishing.")  %>%
      kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE)  %>%
      row_spec(nrow(allyrland_table),bold=T)


```


```{r top_fmp_landings_plots, eval = top_fmp_section, fig.cap="\\label{fig:top_fmp_landings_plots}Landings by FMP, Northeast Canyons and Seamounts addition Area"} 
lp <- ggplot(topFMP, aes(x = Year, y = yfa_land/1000000, fill = FMP)) +
  guides(fill=guide_legend(title=NULL, reverse = TRUE)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0,0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
#  ggtitle(paste0("Landings by FMPs, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale
if (assignedColors) {
  lp <- lp + uniquefmpScale
} else {
  lp <- lp + quantScale
}

# dispay plot
plot(lp)

# save to file
ggsave(filename = file.path(output_ftopfmp, paste0("Top5FMPLand_",substr(broadzone_underscore,0,30),".png")), plot = lp)
# dev.off()
rm(lp) # garbage collection - free up memory
```

```{r top_fmp_revenue_figure, eval = top_fmp_section, fig.cap="\\label{fig:top_fmp_revenue_figure} Revenue (Real 2020USD)  by FMP, Northeast Canyons and Seamounts Addition Area."} 


#######################################################################################
# revenue area

# change order of stack
topFMP$FMP <- reorder(topFMP$FMP, topFMP$yfa_rev)
topFMP$FMP <- factor(topFMP$FMP, levels=levels(topFMP$FMP))

# plot
# rp <- ggplot(topFMP, aes(x = Year, y = yfa_rev/1000000, fill = str_wrap(FMP, width = 30))) +
rp <- ggplot(topFMP, aes(x = Year, y = yfa_rev/1000000, fill = FMP)) +
  guides(fill=guide_legend(title=NULL, reverse = TRUE)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
#  ggtitle(paste0("Revenue by FMP, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale
if (assignedColors) {
  rp <- rp + uniquefmpScale
} else {
  rp <- rp + quantScale
}
# dispay plot
print(rp)
# if number of top 5 fmps for all areas are not the same and are more than the maximum number of colors of the RColorBrewer color palette dont use custom
# ifelse(length(unique(top5byArea$FMP)) > 12, print(rp), print(rp + colScale))
# save to file
ggsave(paste0(output_ftopfmp, "/Top5FMPRev_", substr(broadzone_underscore, 0,30),".png"), plot = rp)
# save to file - base functions
# png(paste0(output_ftopfmp,"/Top5FMPRev_",broadzone,".png"))
# print(rp)
# dev.off()
rm(rp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")
```


```{r landings_by_gear_dataprocess, eval = select_gear_section}  

# REVENUEFILE <- REVENUEFILE_backup

# create new folder for section
dir.create(file.path(output_f, "selectgeartype"), showWarnings = FALSE)
output_fselectgeartype = file.path(output_f, "selectgeartype")



###############################
#### Set Select Gear Types ####
###############################

# New gear types specificed by Min-Yang
select_gear_codes <- as_tibble(REVENUEFILE) %>%
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP")) %>% 
  filter(Area != "Other") %>% 
  mutate(gearcat_new = "") %>% 
  # select(IDNUM, GEARCODE, gearcat_new) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRM','DRO','DRU','DRC', 'DRS','DTS','DTC', 'DSC'), 'DREDGE', gearcat_new)) %>%
  mutate(gearcat_new = ifelse(GEARCODE %in% c('GNS'), 'GILLNET-SINK', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('GND', 'GNO','GNR','GNT'), 'GILLNET-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('FYK','WEI','TRP'), 'WEIR-TRAP', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PUR'), 'SEINE-PURSE', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('SED','SEH','SES','STS'), 'SEINE-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('HND', 'LLB', 'LLP'), 'LINE', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('RAK','DIV','HRP','CST'), 'HAND-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('OBP', 'OHS','OTB','OTC','OTF','OTO','OTR','OTS','OTT','PTB', 'TTS'), 'BOTTOM TRAWL', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTM','OTM'), 'TRAWL-MIDWATER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTC','PTE','PTF','PTH', 'PTO','PTS','PTW','PTX', 'PTL'), 'POT', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('OTH'), 'OTHER', gearcat_new)) %>%  
  mutate(gearcat_new = ifelse(gearcat_new == "", '[blank]', gearcat_new)) 
  
###################################
#### Set Select Gear Types end ####
###################################


################################################################
#### Create Dataframe of Select Gear Types with PII Removed ####
################################################################

# PII fixed for all areas
piiselect_gear_codes <- subset(select_gear_codes, !is.na(gearcat_new)) %>%
  filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP")) %>% 
  dplyr::select(gearcat_new, Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  group_by(gearcat_new, Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(gearcat_new_CONF = ifelse(CONF == T, 'Other Gear', gearcat_new)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("gearcat_new")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, gearcat_new_CONF) %>%
  group_by(gearcat_new_CONF, Year, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("Gear_Type"= gearcat_new_CONF) #%>%
  #filter(Gear_Type !="Other Gear")
  

gear_codesallyr_total <- piiselect_gear_codes %>% dplyr::select(Gear_Type, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(Gear_Type, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

# gear_Type_merge <- merge(piiselect_gear_codes, gear_codesallyr_total, by = c("Gear_Type", "Area"))
# keep as tibble - use dplyr functions insead of base
gear_type_merge <- left_join(piiselect_gear_codes, gear_codesallyr_total, by = c("Gear_Type", "Area"))

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue
# PIISPPNMAllYears[which(PIISPPNMAllYears$FMP == 'MONKFISH JOINT'),"InsideREV_total"] <- PIISPPNMAllYears[which(PIISPPNMAllYears$FMP=='MONKFISH JOINT'),"InsideREV_total"]-227014.9999

#################################################################
#### Create Dataframe of Select Gear_Type with PII Removed end ####
#################################################################

############################################
#### Set plot colors for select species ####
############################################
# create custom color palette for all other unique FMPs 
# (length(unique(gear_type_merge$FMP))-5)
selectGear_TypebyArea <- gear_type_merge %>% group_by(Gear_Type, Area) %>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  group_by(Area) %>% 
  # top_n(., n=((length(unique(gear_type_merge$Gear_Type))-5)*-1), wt=REV) %>% 
  arrange(Area, desc(REV)) %>% 
  ungroup %>% 
  mutate(Gear_Type = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Gear_Type), perl=TRUE)) 

NumUniqueMargins <- length(unique(selectGear_TypebyArea$Gear_Type))

UniqueMargins <- unique(selectGear_TypebyArea$Gear_Type)

# make extra colors if more unique Gear_Types than maximum colors for palette
if (NumUniqueMargins > maxUniqueColors) {
  getPalette = colorRampPalette(brewer.pal(maxUniqueColors, paletteName3))
  myColors <- getPalette(NumUniqueMargins) 
} else {
  myColors <- brewer.pal(NumUniqueMargins, paletteName3) # create list of colors using number of unique Gear_Types from pallettte name
}

names(myColors) <- UniqueMargins # name colors for color scale

uniqueSelectGear_TypeScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))

# original color scale based on revenue quanities
quantGear_TypeScale <- scale_fill_viridis(discrete=TRUE)

rm(NumUniqueMargins, UniqueMargins) # garbage collection


broadzone <-allZones[1]


#### get rev and landing plots and tables for all zones
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area

###################################################################
# landings plot and table
  
# filter by area
sGear_TypeArea <- gear_type_merge %>% filter(Area == broadzone_underscore)

# make Gear_Type names lowercase
sGear_TypeArea$Gear_Type <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sGear_TypeArea$Gear_Type), perl=TRUE)
# sGear_TypeArea$Gear_Type[sGear_TypeArea$Gear_Type=="None"] <- "No Federal FMP"

# change order of stack
sGear_TypeArea$Gear_Type <- reorder(sGear_TypeArea$Gear_Type, sGear_TypeArea$yfa_land)
sGear_TypeArea$Gear_Type <- factor(sGear_TypeArea$Gear_Type, levels=levels(sGear_TypeArea$Gear_Type))

# sGear_TypeArea$Gear_Type <- reorder(sGear_TypeArea$Gear_Type, sGear_TypeArea$sum_rev)
# sGear_TypeArea$Gear_Type <- factor(sGear_TypeArea$Gear_Type, levels=levels(sGear_TypeArea$Gear_Type))
```



```{r landings_table_by_gear, eval = select_gear_section}  

# sort by landings
allyrland_table <- subset(sGear_TypeArea, select = -Year ) %>%  
  # select(Gear_Type, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Gear_Type, allyrtotal_rev, allyrtotal_land) %>%
  arrange(desc(allyrtotal_land)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Gear_Type, allyrtotal_land) %>% 
  dplyr::mutate(allyrtotal_land=allyrtotal_land/numeric_years) %>% 
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  dplyr::rename("Gear Type" = Gear_Type) %>% 
  ungroup()

  
# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$"Gear Type" <- as.character(allyrland_table$"Gear Type")
allyrland_table <- rbind(allyrland_table, c("Total", colSums(allyrland_table[,2]))) # allyrland_table must be a tibble and without year column for this to work
# allyrland_table$`All Year Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Year Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- "Average Projected Landings"

#kbl(allyrland_table, booktabs=T,  align=c("l",rep('r',times=1)), caption = "Projected commercial landings (pounds) that would occur in the NCSMNM addition if it was reopened to fishing based on 2012-2016.")  %>%
#      kable_styling(full_width = F) %>%
#     row_spec(nrow(allyrland_table),bold=T)  %>% 
#      row_spec(0,bold=TRUE) 
```

```{r revenue_table_by_gear, eval = select_gear_section}  
##########################################################################

# sort by revenue
allyrrev_table <- subset(sGear_TypeArea, select = -Year ) %>%  
  # select(Gear_Type, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Gear_Type, allyrtotal_rev) %>%
  arrange(desc(allyrtotal_rev)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Gear_Type, allyrtotal_rev) %>% 
  dplyr::mutate(allyrtotal_rev=allyrtotal_rev/numeric_years) %>% 
  dplyr::rename("All Year Total" = allyrtotal_rev) %>% 
  dplyr::rename("Gear Type" = Gear_Type) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$"Gear Type" <- as.character(allyrrev_table$"Gear Type")
allyrrev_table <- rbind(allyrrev_table, c("Total", colSums(allyrrev_table[,2]))) # allyrrev_table must be a tibble and without year column for this to work
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrrev_table)[names(allyrrev_table) == "All Year Total"] <- paste0("Average Projected  Revenue")


allyrrev_table <-allyrrev_table %>%
  left_join(allyrland_table, by="Gear Type") %>%
  relocate(`Average Projected  Revenue`, .after=last_col()) 

kbl(allyrrev_table, booktabs=T,  align=c("l",rep('r',times=2)), caption = "Projected commercial landings (pounds) and revenue that would occur in the NCSMNM addition if it was reopened to fishing based on 2012-2016 fishing patterns.")  %>%
      kable_styling(full_width = T) %>%
      row_spec(nrow(allyrrev_table),bold=T) %>% 
      row_spec(0,bold=TRUE) 
```

Two caveats are necessary. First, these tables and figures *under-represent* fishing activity attributable to the lobster fishery and pot/trap gears because vessel operators that hold a lobster permit and no other federal permit are not required to fill out vessel trip reports. Therefore, it *under-estimates* the annual fishing activity associated with a resumption of commercial fishing in the NCSMNM addition.

Second, these figures represent activity that is likely to occur if commercial fishing can resume in the NCSMNM addition, but are likely to *over-estimate* the benefits to the fishing industry.  This occurs for a few reasons. First, firm profits must be less than gross revenues, because there are costs associated with harvesting fish. Second, not all of the fishing activity described in Figures \ref{fig:top_fmp_landings_plots} and \ref{fig:top_fmp_revenue_figure} represents "new" fishing activity that would be undertaken in the NCSMNM addition area.  Some of this economic activity stems from fishing trips that currently occur in similar (and presumably less profitable) locations.  For these trips, the gains associated the NCSMNM addition is the difference in profits between fishing in the current locations and fishing in NCSMNM.

<!-- Table \ref{tab:total_fishing_START} describes landings and real revenues over the  `r START.YEAR` - `r END.YEAR` time period, disaggregated by Fishery Management Plan, in all areas.  Landings and Revenue derived from Jonah Crab are aggregated into the Lobster FMP. Landings and revenue derived from Red Crab are aggregated into the "Other NER" category.  These data *under-represent* fishing activity attributable to the lobster fishery because vessel operators that hold a lobster permit and no other federal permit are not required to fill out vessel trip reports. -->


```{r total_fishing_START,eval=FALSE}

# THE total revenue summation only works if the input shapefile has just 1 polygon. If a gearid can be in two places at once, watchout, the summation won't work.
# This needs to be checked. I don't think I have the right number of years. Check numyear.
# This is "DMIS-Raster" based, but it's better to just go to CFBBS.
nd_area <- n_distinct(REVENUEFILE$Area)
if(nd_area>2){
    warning('More than one area. Lookout!')
}
# PII fixed for all areas
Total_REV <- REVENUEFILE %>%
 filter(!FMP %in% c("SERO FMP","Highly Migratory Species","No Federal FMP", "ASMFC FMP"))%>%
 filter(Year>=START.YEAR & Year<=END.YEAR) %>%
  mutate(FMP = ifelse(FMP == "Red Crab", 'All Others', FMP)) %>% #rebin red crab to All Others
  mutate(FMP = ifelse(FMP == "Tilefish", 'All Others', FMP)) %>% #rebin tilefish to All Others
  mutate(FMP = ifelse(FMP == "All Others ", 'Other NER', FMP)) %>% #Rename All Others to Other NER
group_by(FMP) %>%
  dplyr::summarize(
    QTYKEPT = round(sum(QTYKEPT/(numeric_years*1000000), na.rm = T),1),
    REVENUE = round(sum(REVENUE/(numeric_years*1000000), na.rm = T),1)) %>%
arrange(desc(REVENUE)) %>%
  bind_rows(summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")) %>%
  mutate(REVENUE=format(REVENUE, big.mark=",")) %>%
  mutate(QTYKEPT=format(QTYKEPT, big.mark=","))

# names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Total")
names(Total_REV)[names(Total_REV) == "REVENUE"] <- paste0(numyear, " Year Average Revenue")
names(Total_REV)[names(Total_REV) == "QTYKEPT"] <- paste0(numyear, " Year Average Landings")

kbl(Total_REV, booktabs=T,  align=c("l",rep('r',times=2)), caption = "2012-2016 Year Average Landings (Millions of Pounds) and Revenue (Millions of 2020 Dollars), All Areas")  %>%
      kable_styling(full_width = T) %>%
      row_spec(nrow(Total_REV),bold=T)  %>% 
      row_spec(0,bold=TRUE) %>%
      add_footnote(c("Lobster landings and revenue are underrepresented because not all lobster vessels are required to fill out logbooks."), notation = "symbol")
```
<!---
We note that American Lobster and Red Crab fisheries would not be impacted unil September 15, 2023.  Annual lobster landings have averaged `r lobster_lbs` pounds per year and `r lobster_rev ` per year over the `r START.YEAR` to `r END.YEAR` time period.  Red crab landings cannot be reported due to data confidentiality reasons and are aggregated into the "Other NER" and have averaged less than `r other_lbs` pounds per year and `r other_rev` per year over this time period.
--->





```{r landings_plot_by_gear, eval = select_gear_section,  fig.cap="\\label{fig:landings_gear_plot} Landings by Gear, Northeast Canyons and Seamounts addition Area"}  

# plot
lp <- ggplot(sGear_TypeArea, aes(x = Year, y = yfa_land/1000000, fill=Gear_Type)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  #ggtitle(paste0(" Landings of Select Gear Types, ",broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  lp <- lp + uniqueSelectGear_TypeScale
} else {
  lp <- lp + quantGear_TypeScale
}
# dispay plot
print(lp)

```

```{r revenue_plot_by_gear, eval = select_gear_section, fig.cap="\\label{fig:revenue_gear_plot}Revenue by Gear, Northeast Canyons and Seamounts addition Area"}  
###################################################################
# revenue plot and table

rm(sGear_TypeArea)

sGear_TypeArea <- gear_type_merge %>% filter(Area == broadzone_underscore)

# make FMP names lowercase
sGear_TypeArea$Gear_Type <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sGear_TypeArea$Gear_Type), perl=TRUE)
# sGear_TypeArea$Gear_Type[sGear_TypeArea$Gear_Type=="None"] <- "No Federal FMP"

# change order of stack
sGear_TypeArea$Gear_Type <- reorder(sGear_TypeArea$Gear_Type, sGear_TypeArea$yfa_rev)
sGear_TypeArea$Gear_Type <- factor(sGear_TypeArea$Gear_Type, levels=levels(sGear_TypeArea$Gear_Type))


# plot
rp <- ggplot(sGear_TypeArea, aes(x = Year, y = yfa_rev/1000000, fill=Gear_Type)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  #ggtitle(paste0("Revenue from Select Gear Types, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  rp <- rp + uniqueSelectGear_TypeScale
} else {
  rp <- rp + quantGear_TypeScale
}
# dispay plot
print(rp)
# save to file
ggsave(paste0(output_fselectgeartype, "/Select_Gear_Type_Rev_", substr(broadzone_underscore,0,30),".png"), plot = rp)
rm(rp)
```

#### Baseline Description - Other sources of Economic Value

The seafloor status in NCSMNM can be thought of as a capital asset.  Beyond it's value derived from the unique ecological resources that are subject to scientific interest, the seafloor provides ecoystem services, including habitat for species that are commercially valuable.  The quality of the capital asset decreases after fishing occurs when bottom-contact from fishing gear damages the unique oceanographic formations or destroys marine life.  Because fauna in the area (like deep-sea coral and sponges) grow, the habitat can slowly regenerate after these events. However, coral and sponges are fragile, slow-growing, and relatively immobile, so even small amounts of intermittent activity may have long-lasting, negative impacts on the stock of habitat in NCSMNM. 

NCSMNM can provide economic benefits in through extractive and non-extractive means.  First, high-quality habitat can increase the stocks of recreationally and commercially exploited species.  It may also agglomerate stocks of exploited species, making them easier to harvest.  Although commercial fishing is currently prohibited in the NCSMNM, a portion of these extractive benefits still exist: mature fish move in and out of the protected area and produce offspring that move outside the protected area [@Holland1996] These are extractive uses.  Second, the NCSMNM can be associated with existence and bequest uses: the people of the nation may derive value  from knowing the NCSMNM exists and knowing that it will continue to exist for future generations. 

Figure \ref{fig:landings_gear_plot} and Table \ref{tab:revenue_table_by_gear} describe landings from `r START.YEAR` to `r END.YEAR` that occurred within the NCSMNM boundary addition. They are disaggregated by gear to provide some insight into the possible declines in the stock of habitat in the area if fishing resumed.  We note that most of the catch in the NCSMNM is from gear that gear that  contacts the bottom while active (Dredge, Bottom Trawl).


<!---
A reduction in ecosystem benefits stemming from reduced protection in NCSMNM represents a cost to society.  A reduction in compliance costs for the fishing industry stemming from reduced protections in NCSMNM represents benefits to society. The proposed action would remove both of remove the probability of these changes.  This can be counter-intuitive for people.
--->


#### Economic Effects of the Proposed Regulation 

The proposed action would make not changes to the types of fishing activities that can be currently conducted in the NCSMNM; fishing is likely to continue at levels described in Table \ref{tab:baseline_revenues}.  However, the proposed action greatly reduces the probability that the NCSMNM addition would reopened to commercial fishing in the future. This change in probability has benefits and costs to the nation.

Relative to the baseline, the benefits of the proposed action include annual bequest values, existence values, and incremental contribution of the NCSMNM habitat to the productivity of commercial valuable resources that are harvested outside of the NCSMNM areas.  These must be adjusted by the probability that the protections for NCSMNM would be rescinded in the future and discounted from that unknown point in time to the current time.   All of these values are difficult to quantify.

Relative to the baseline, the costs of the proposed action are equal to the losses in societal welfare (a combination of producer and consumer welfare) associated with the inability to fish in the NCSMNM.  These also must be adjusted by the probability that the protections for NCSMNM would be rescinded in the future and discounted from that unknown point in time to the current time.  We are unable to estimate the changes societal welfare from fishing within in the areas of the preferred alternative. Instead we present an estimate of revenue and landings that may return to the NCSMNM addition as an estimate of the potential scale of the industry.  These revenue and landings figures are contained in Table \ref{tab:revenue_table_by_gear} and  Figures \ref{fig:top_fmp_landings_plots} -\ref{fig:revenue_gear_plot}.  

### Social  Effects

I don't know.

\clearpage

\setcounter{section}{5}
\setcounter{subsection}{11}
<!---
## Regulatory Impact Analysis and Initial Regulatory Flexibility Analysis

This document provides the analysis and conclusions to address the requirements of Executive Order 12866 and the Regulatory Flexibility Act (RFA).  NMFS requires the preparation of a Regulatory Impact Analysis (RIA) for all regulatory actions that either implement or significantly amend a Fishery Management Plan (FMP). The RIA provides a comprehensive review of the changes in net economic benefits to society associated with proposed regulatory actions. This analysis reviews the problems and policy objectives prompting the regulatory proposals and evaluates the alternatives presented as a solution. This analysis ensures that we systematically and comprehensively consider all available alternatives so public welfare can be enhanced in the most efficient and cost-effective way. This RIA addresses multiple items in the regulatory philosophy and principles of Executive Order (EO) 12866. 

An Initial Regulatory Flexibility Analysis (IRFA; section [Regulatory-Flexibility-Act-Analysis]) has been prepared to further evaluate the economic impacts of the various alternatives presented in this document on regulated small business entities. --->

## Regulatory Impact Analysis (E.O. 12866)

The purpose of Executive Order 12866 (E.O. 12866, 58 FR 51735, October 4, 1993) is to enhance planning and coordination with respect to new and existing regulations. This E.O. requires the Office of Management and Budget (OMB) to review regulatory programs that are considered to be significant. E.O. 12866 requires a review of proposed regulations to determine whether or not the expected effects would be significant, where a significant action is any regulatory action that may:

*  Have an annual effect on the economy of $100 million or more, or adversely affect in a material way the economy, a sector of the economy, productivity, jobs, the environment, public health or safety, or State, local, or tribal governments or communities;
*  Create a serious inconsistency or otherwise interfere with an action taken or planned by another agency;
*  Materially alter the budgetary impact of entitlements, grants, user fees, or loan programs or the rights and obligations of recipients thereof; or
*  Raise novel legal or policy issues arising out of legal mandates, the Presidents priorities, or the principles set for the Executive Order.
 
In deciding whether and how to regulate, agencies should assess all costs and benefits of available regulatory alternatives. Costs and benefits shall be understood to include both quantifiable measures (to the fullest extent that these can be usefully estimated) and qualitative measures of costs and benefits that are difficult to quantify, but nevertheless essential to consider. 

Fishing in NCSMNM (with limited temporary exceptions) is currently prohibited by presidential proclamation and the propsed action does not change the currently allowed fishing areas.  Instead, the proposed action codifies Proclamation 9496, as amended by Proclamation 10287, into regulation. These proclamations directed the Secretaries of Commerce and Interior to promulgate regulations necessary for the proper care and management of the Monument. 
The costs, relative to the *status quo*, are opportunity cost of fishing adjusted by the likelihood that future administrations would reopen the NCSMNM to commercial fishing. Fishing in much of the NCSMNM (with limited exceptions) is currently also prohibited through the Georges Bank Deep-Sea Coral Protection Area, which was implemented through the NEFMC's Omnibus Deep-Sea Coral Amendment (86 FR 33553).

The benefits, relative to the *status quo*, are derived from an increased level of certainty in improving the condition of corals, sponges, and other deep-sea fauna in NCSMNM and indirectly improving the production of other species which rely on this habitat. Due to data limitations we were not able to quantify the costs or benefits of this rule associated with habitat conservation. Still, we believe that the overall impact of the proposed rule falls well short of the annual \$100 million threshold for a significant economic action because Vessel Trip Reports indicate that fishing vessels would derive \$1-2 million in annual gross revenue from the NCSMNM Addition. 


### Management Goals and Objectives

The goal of this amendment is to protect the geological, ecological, and biological resources within the Monument.  This amendment is needed to codify Proclamation 9496, as amended by Proclamation 10287, which directs the Secretaries to promulgate regulations necessary for the proper care and management of the Monument.

### Description of the Fishery and other affected entitites

See Section 3.0 for a description of the fisheries.  Section \ref{Baseline_Description_Fishery} summarizes relevant aspects of the fishery.

### Statement of the Problem - Market Failure {#market_failure}

Habitat inside NCSMNM is important for a  host of species including managed species such as cod and American anglerfish, and unmanaged species including a host of both vertebrate and invertebrate animals.  Deep-sea corals and other fauna in the NCSMNM are slow growing and some species have limited dispersal capability. These features, combined with the branching and sometimes brittle structure of some taxa, make them vulnerable to mechanical disturbance, such as from fishing gear.  

NCSMNM can provide economic benefits in through extractive and non-extractive means.  First, high-quality habitat can increase the stocks of recreationally and commercially exploited species.  It may also agglomerate stocks of exploited species, making them easier to harvest.  These benefits  do not necessarily cease when commercial fishing inside the areas is prohibited: mature fish may move outside the protected area or produce offspring that move outside the protected area [@Holland1996] These are extractive uses.  Second, the NCSMNM can be associated with existence and bequest uses: the people of the nation may derive value  from knowing the NCSMNM exists and knowing that it will continue to exist for future generations.  

As a nonmarket good subject to open access, habitat is a good that economists expect to be overutilized without management intervention.  This is because the impacts of fishing on both the structure and function of deep-sea coral is not factored into an individual fishermans decision-making. In the absence of corrective policies, the actions of individual profit-maximizing firms imposes an externality; excess degradation of habitat above and beyond a socially optimal level. For quickly regenerating substrate and habitat, like featureless sandy bottoms with high flow of water, the practical effects of these externalities are likely minimal.  However, for habitat in the NCSMNM, the effects may be larger.  First, the functional degradation of habitat can impact the productivity of managed and unmanaged species that rely on the flora and fauna in the area. These impacts can lead to decreases in the future flow of benefits derived from recreationally and commercially exploited species. Second, these impacts can decrease the flow of nonuse values such as bequest and existence value of both the habitat and environment, including things like deep sea coral and other species.  

A cause and effect relationship between high-quality habitat and fish populations is hard to determine, and our understanding of relationships between deep-sea corals and fishes is situational and inferential (e.g., Baker et al. 2012), particularly in seamount habitats [@auster2007linking]. At the Gulf of Maine sites, economically important species were observed in coral habitats, including Acadian redfish (juveniles, adults, and pregnant females), haddock, pollock, cusk, monkfish, cod, silver hake, Atlantic herring, spiny dogfish, squid, and lobster. There is recent evidence that deep-sea corals play an important role in the early life history of some fish and shark species, providing nursery grounds and habitat for protection, reproduction, and feeding [@costello2005role] . @baillon2012deep collected sea pens as trawl bycatch during routine multispecies research surveys and found convincing evidence that several species of sea pens, including *Pennatula aculeata*, *Anthoptilum grandiflorum*, *Pennatula grandis*, and *Halipteris finmarchica*, are being directly utilized as shelter by fish larvae, mainly by those of the redfish (*Sebastes* spp.), one species of which is federally managed under the Northeast Large Mesh Multispecies FMP.  Thus, though the co-occurrence of deep sea coral and species of interest is suggestive, the extent to which productivity of managed and unmanaged species relies on these deep sea coral is highly uncertain, even in qualitative terms. 

The economic values of conservation associated with deep sea corals, including bequest and existence values, are not as well studied as those associated with tropical corals (Figure \ref{fig:coral_lit_table}). What value estimates exist focuses on two countries, Norway and Ireland, and in reality rely on only 3 datasets.  Of note is that a number of these studies indicate heterogeneity in both individuals willingness to pay for conservation across both countries and allowable activities within conservation areas. For example, @armstrong2019willingness indicates that the Irish public are less willing than Norwegians to trade extractive activities such as fishing and mining off against conservation, the latter weighing pure existence value higher than the former. Additionally, @lariviere2014value, @aanesen2015willingness; @sandorf2016valuing, and @sandorf2017disentangling all rely on the same data, with the differences in estimates depending on how the heterogeneity in preferences across individuals is modeled.  A similar heterogeneity between both individuals and allowable uses has been identified in the Northeast, with some individuals even reporting negative willingness to pay for increases in the size of marine protected areas [@wallmo2008estimating]. The literature search highlights that estimated values are sensitive to the context in which they are solicited, and should account for heterogeneity in preferences for conservation. The values presented in Table 1 thus do not provide great clarity in informing estimation of the value of deep sea coral conservation undertaken within this action. As such, we discuss the benefits of deep sea coral conservation in a qualitative manner. The preferred alternatives designate three coral zones along the shelf break out to the EEZ boundary and in the inshore Gulf of Maine. Given the location of these zones and the specific fishing restriction measures associated with them, they are not likely to cause substantial displacement of fishing effort and therefore substantial increased conservation in the near term, but they will prevent expansion of fishing into these areas in the future. Thus, the benefits of this action derived from conservation of deep-sea corals and managed resources which utilize coral habitats are expected to be positive in direction, but slight in magnitude, and accrue over a long time horizon.
```{r clt, out.width = "500px", fig.align="center", fig.cap="\\label{fig:coral_lit_table}Valuation studies for Deep Sea Corals"}
knitr::include_graphics(here("writing","Canyons","Coral_lit_table.png"))
```

<!---
\addtocounter{figure}{-1}
\addtocounter{table}{1}

I've added a table as a figure. So I'm going to add 1 to the Tables Counter and subtract 1 from the figures counter. This is a hack and a half that only works because it's the first table or figure. Otherwise I'd have to setcounter by hand. 

Citation	Country	Empirical Approach	Average Willingness to Pay Estimated
Armstrong, C.W., Aanesen, M., van Rensburg, T.M. and Sandorf, E.D., 2019. Willingness to pay to protect cold water corals. Conservation Biology, 33(6), pp.1329-1337.	Norway, Ireland	Choice Experiments	NKra 341 ($39)/year/household for 2,500km2 increase
NKra 424 ($48)/year/household for 7,500km2 increase
NKra 880 ($100)/year/household if important fish habitat
Glenn, H., Wattage, P., Mardle, S., Van Rensburg, T., Grehan, A. and Foley, N., 2010. Marine protected areas  substantiating their worth. Marine Policy, 34(3), pp.421-430.	Ireland	Choice Experiments	Insignificant estimates
Sandorf, E.D., Aanesen, M. and Navrud, S., 2016. Valuing unfamiliar and complex environmental goods: A comparison of valuation workshops and internet panel surveys with videos. Ecological Economics, 129, pp.50-61.	Norway	Choice Experiments	NKra 230-284 ($33-$41)/year/household for 7,500km2 increase
NKra 457-1,009 ($66-$146)/year/household if important fish habitat
LaRiviere, J., Czajkowski, M., Hanley, N., Aanesen, M., Falk-Petersen, J. and Tinch, D., 2014. The value of familiarity: effects of knowledge and objective signals on willingness to pay for a public good. Journal of Environmental Economics and Management, 68(2), pp.376-389.	Norway	Choice Experiments	NKra 573 ($87)/year/household for 7,555km2 increaseb
NKra 1007-2036 ($153-$310)/year/household if important fish habitat
NKra 232-256 ($35-$39)/year/household add. to protect from fishing
NKra 257 ($39)/year/household add. to protect from oil drillingb
Aanesen, M., Armstrong, C., Czajkowski, M., Falk-Petersen, J., Hanley, N. and Navrud, S., 2015. Willingness to pay for unfamiliar public goods: preserving cold-water coral in Norway. Ecological Economics, 112, pp.53-67.	Norway	Choice Experiments	EURa 53 ($63)/year/household for 2,555km2 increase
EURa 67 ($80)/year/household for 7,555km2 increase
EURa 166 ($197)/year/household if important fish habitat
EURa 39 ($46)/year/household add. to protect from fishing
EURa 16 ($19)/year/household add. to protect from oil drilling
Sandorf, E.D., Campbell, D. and Hanley, N., 2017. Disentangling the influence of knowledge on attribute non-attendance. Journal of choice modelling, 24, pp.36-50.	Norway	Choice Experiments	NKra 314 ($45)/year/household for 2,500km2 increasec
NKra 370 ($53)/year/household for 7,500km2 increasec
NKra 292 ($42)/year/household if important fish habitatc 
NKra -9 (-$1)/year/household add. to protect from fishingc
NKra -37 (-$5)/year/household add. to protect from oil drillingc
Wattage, P., Glenn, H., Mardle, S., Van Rensburg, T., Grehan, A. and Foley, N., 2011. Economic value of conserving deep-sea corals in Irish waters: a choice experiment study on marine protected areas. Fisheries Research, 107(1-3), pp.59-67.	Ireland	Choice Experiments	Insignificant estimates
--->

### Economic impacts relative to the baseline
The proposed action would make not changes to the types of fishing activities that can be currently conducted in the NCSMNM; fishing is likely to continue at levels described in Table \ref{tab:baseline_revenues}.  However, the proposed action greatly reduces the probability that the NCSMNM addition would reopened to commercial fishing in the future. 

Relative to the baseline, the costs of the proposed action are equal to the losses in societal welfare (a combination of producer and consumer welfare) associated with the inability to fish in the NCSMNM.  These also must be adjusted by the probability that the protections for NCSMNM would be rescinded in the future and discounted from that unknown point in time to the current time.  We are unable to estimate the changes societal welfare from fishing within in the areas of the preferred alternative.  Instead we present an estimate of revenue and landings that may return to the NCSMNM addition as an estimate of the potential scale of the industry.  The economic impacts on the fishery are described in Section \ref{Econ-Effects} are briefly summarized here. Gross receipts in the Northeast fishing industry average \$1.4B per year (Table \ref{tab:baseline_revenues}).  The proposed regulation would preclude commercial fishing in the NCSMNM addition; the regulated fishing vessels are projected to derive just under \$1M from fishing inside the NCSMNM addition area.  These are revenues that are foregone and gives a sense of the scale of the economic effects on the fishing industry.  The scallop fishery would experience the highest impacts in  dollar values (\$590,000).  The Mackerel, Squid, and butterfish fishery would experience the largest impacts in term of volume (137,000 lbs).  In relative terms, all fisheries derive well under 1\% of revenue from the NCSMNM addition area. 

Relative to the baseline, the benefits of the proposed action include annual bequest values, existence values, and incremental contribution of the NCSMNM habitat to the productivity of commercial valuable resources that are harvested outside of the NCSMNM areas.  We note that these values may increase rapidly when habitat is in a high quality stat.  Due to the slow growing nature of the fauna in NCSMNM, even short bursts of fishing effort that contacts the bottom could degrade the habitat quickly.  These benefits must be adjusted by the probability that the protections for NCSMNM would be rescinded in the future and discounted from that unknown point in time to the current time.  All of these values are difficult to quantify.


\newpage

## Regulatory Flexibility Act Analysis

###  A description of the reasons why action by the agency is being considered.
By reference

### A succinct statement of the objectives of, and legal basis for, the proposed rule.
By reference

### Number of Small entities

The directly regulated entities are the firms that currently hold at least 1 Northeast US fishing permit that could be used to fish in the Northeast Canyons and Seamounts. A few permit categories (Lobster: A1, A2, A4, A5, A5W, A6, and AOC; General Category Scallop B) were not included when constructing the set of directly regulated entities because these permit categories to not enable a vessel to fish in the Northeast Canyons and Seamounts areas.  There are a total of 1,338 small firms and 11 Large firms.  1,024 of the small firms derive the majority of their revenue from commercial fishing operations.  314 derive the majority of their revenue from for-hire recreational activities.  Firms that are classified as "for-hire" may still fish commercially -- these firms are included in the tabulation of directly regulated entities, although their main source of income (for-hire fishing) would not be directly impacted  by the proposed action. 

```{r Directly_Regulated_Entities, eval=TRUE}
load(RFA_filepath)
affiliates<-affiliates_2022_06_01
rm(affiliates_2022_06_01)
affiliates$permit_count<-1
# Recode small_business to a print friendly string (Large, Small). Recode entity_type to nice casing

affiliates<-affiliates %>%
  mutate(entity_type_2021=replace(entity_type_2021, entity_type_2021=="FISHING","Fishing"),
         entity_type_2021=replace(entity_type_2021, entity_type_2021=="FORHIRE","For-Hire"),
         SB_string=case_when(
           small_business==1 ~ "Small",
           small_business==0 ~ "Large")
         ) %>%
    relocate(SB_string, .after=small_business) 


aff_key <- affiliates %>%
  filter(year==2021) %>%
  mutate(Type=entity_type_2021, Size=SB_string) %>%
  select(affiliate_id,permit,Size, Type)


# Just look at the 2021 data. Drop permit columns corresponding to Lobster A1, A2, A4, A5, A6, AOC, and A5W because they cannot currently fish in that area.  Get the entity type, small business dummy, and the number of federal permits, and the number of vessels as well. The filter(total>=1) actually cuts out alot of rows
A2021<-affiliates %>%
  filter(year==2021) %>%
  select(-c(LO_A1,LO_A2,LO_A4, LO_A5, LO_A6, LO_AOC, LO_A5W, LGC_B)) %>%
  group_by(affiliate_id) %>%
  summarise(Type=first(entity_type_2021), Size=first(SB_string),
            vessels=sum(permit_count),
            total=sum(c_across(BLU_1:TLF_3)),
            lob=sum(c_across(starts_with("LO_"))),
            redcrab=sum(c_across(starts_with("RCB_")))) %>%
  filter(total>=1)


# average revenues, including average revenues by species. Rename the value_permit to value_firm to reflect the change in the column when we summarize across  
  summary_affiliates<-affiliates %>%
  group_by(affiliate_id,year) %>%
  summarise(across(value_permit:value834, sum)) %>%
    ungroup() %>%
  group_by(affiliate_id) %>%
  summarise(across(value_permit:value834, mean)) %>%
    rename(value_firm=value_permit, value_firm_forhire=value_permit_forhire)
            

#merge them together.
Directly_Regulated_Entities<-left_join(A2021,summary_affiliates,by='affiliate_id')

# Summary of DRE large and small firms in the fishing and for-hire industries.
# Should recode small_business to a print friendly string (Large, Small)
Directly_Regulated_Entities_table <- Directly_Regulated_Entities %>%
  filter(Type !="NO_REV") %>%
  group_by(Size, Type) %>%
  summarise(Firms=n(),
            Vessels=sum(vessels),
            "Avg Gross Receipts"=round(mean(value_firm),0),
            "Average For-Hire Receipts"=round(mean(value_firm_forhire),0),
            "25th pct Gross Receipts" = round(quantile(value_firm, probs=.25),0),
            "75th pct Gross Receipts"=round(quantile(value_firm, probs=.75),0)
           ) %>%
  mutate(across(c(`Firms`,`Vessels`), ~ number(.x, big.mark=","))) %>%
  mutate(across(c(`Avg Gross Receipts`,`Average For-Hire Receipts`,`25th pct Gross Receipts`, `75th pct Gross Receipts` ), ~ number(.x, accuracy=1000,prefix="$", big.mark=",")))

 
kbl(Directly_Regulated_Entities_table, digits=0,booktabs=T, align=c("l",rep('r',times=7)), caption =  "Number and Characterization of the  Directly Regulated Entities") %>%
    #column_spec(5:8, width = "2cm")
    kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE) 
```

Table \ref{tab:Directly_Regulated_Entities} describes numbers of directly regulated entities, their main activities, and their revenues from various sources. The distribution of gross receipts for both classes is highly right-skewed: there are many firms with a small to moderate amount of gross receipts and a handful of firms with much more economic activity. This results in the average receipts being higher than the 75$^th$ percentile of gross receipts for these two groups.

SBA mandates the use of the three most recent years of data to determine whether an entity is small or large.  Using this time period (2019-2021) to describe the importance of NCSMNM to these firms is not appropriate, because the area was not open to fishing for much of this time.  Therefore, the fishing activity during the 2012-2016 time period are used characterize the importance of NCSMNM.  Table \ref{tab:Firm_average_in_Area} describes the Gross Receipts from all sources and from just within the NCSMNM addition. Table \ref{tab:AnyInside} describes the Gross Receipts from all sources and from just within the NCSMNM addition only for firms that fished inside the NCSMNM addition area.  None of the firms classified as "For-Hire" firms were active inside the NCSMNM addition area.

```{r Firm_average_in_Area}
aff_key <- affiliates %>%
  filter(year==2021) %>%
  filter(entity_type_2021 !="NO_REV") %>%
  mutate(Type=entity_type_2021, Size=SB_string) %>%
  select(affiliate_id,permit,Size, Type)
  
REVENUEFILE_permit <-REVENUEFILE %>%
  mutate("Year" = as.numeric(Year)) %>%
  filter(Year >=2012 & Year<=2016) %>%
  group_by(PERMIT, Year) %>%
  summarise(InsideREV=sum(InsideREV,na.rm = T), 
            TotalREV=sum(REVENUE,na.rm = T)) %>%
  ungroup()

# A join off aff_key to REVENUEFILE_permit is tricky because they years don't match up.  
# Firms in REVENUEFILE_permit that are not in aff_key.  These stopped fishing between 2016 and 2021.
# Firms in aff_key and not in REVENUEFILE -- these are firms that started fishing after 2016.  
# Therefore, we need an inner_join here.

Firm_activity <- aff_key %>%
  inner_join(REVENUEFILE_permit, by=c("permit"="PERMIT"))

#Filter out the firms that were inactive in 2021 (Type=="NO_REV")
DRE_2012_2016Firms <- Firm_activity %>%
  filter(Type !="NO_REV") %>%
  group_by(Size,Type,affiliate_id, Year) %>%
  summarise(TR=sum(TotalREV, na.rm=T),
            TRinside=sum(InsideREV, na.rm=T) ) %>%
  mutate("Percent inside NCSMNM"=TRinside/TR)  %>%
  ungroup() %>%
  group_by(Size, Type, Year) %>%
  summarise(Firms=n_distinct(affiliate_id),
            "Average Gross Receipts"=round(mean(TR, na.rm=T),0),
            "Average Gross Receipts in NCSMNM addition"=round(mean(TRinside, na.rm=T),0),
            "Average % in NCSMNM addition"=percent(mean(`Percent inside NCSMNM`), accuracy=.01 ) ) %>%
  mutate(across(c(`Firms`), ~ number(.x, big.mark=","))) %>%
  mutate(across(c(`Average Gross Receipts`,`Average Gross Receipts in NCSMNM addition` ), ~ number(.x, accuracy=100,prefix="$", big.mark=",")))

kbl(DRE_2012_2016Firms, digits=0,booktabs=T,  align=c("l",rep('r',times=6)), caption =  "Yearly Average Revenues (2012-2016), RFA Directly Regulated Entities")   %>%
    #column_spec(5:8, width = "2cm")
    kable_styling(full_width = T) %>% 
      row_spec(0,bold=TRUE) 
```

Tables \ref{tab:Firm_average_in_Area}  and \ref{tab:AnyInside} suggest that the NCSMNM addition area are not highly used by fishing firms.  Every year, approximately 100 fishing firms derive some fishing revenue from the NCSMNM addition area (Table \ref{tab:AnyInside}).  Compliance costs, measured as foregone revenue from this area, are expected to be low.  On average, firms derived less than 1\% of annual fishing revenue from this area, and typically substantially less than this.  

```{r AnyInside}

DRE_2012_2016InsideOnly <- Firm_activity %>%
  filter(Type !="NO_REV") %>%
  group_by(Size,Type,affiliate_id, Year) %>%
  summarise(TR=sum(TotalREV, na.rm=T),
            TRinside=sum(InsideREV, na.rm=T) ) %>%
  mutate("Percent inside NCSMNM"=TRinside/TR)  %>%
  filter(TRinside>=1) %>%
  ungroup() %>%
  group_by(Size, Type, Year) %>%
  summarise(Firms=n_distinct(affiliate_id),
            "Average Gross Receipts"=round(mean(TR, na.rm=T),0),
            "Average Gross Receipts in NCSMNM addition"=round(mean(TRinside, na.rm=T),0),
            "Average % in NCSMNM addition"=percent(mean(`Percent inside NCSMNM`), accuracy=.01 ) ) %>%
  mutate(across(c(`Firms`), ~ number(.x, big.mark=","))) %>%
  mutate(across(c(`Average Gross Receipts`,`Average Gross Receipts in NCSMNM addition` ), ~ number(.x, accuracy=100,prefix="$", big.mark=",")))



kbl(DRE_2012_2016InsideOnly, digits=0,booktabs=T,  align=c("l",rep('r',times=6)), caption =   "Yearly Average Revenues (2012-2016), RFA Directly Regulated Entities that are Active in the NCSMNM")  %>%
    #column_spec(5:8, width = "2cm")
    kable_styling(full_width = T) %>% 
    row_spec(0,bold=TRUE) 

```


### Percentage of Revenue by Firm

We also plot the percentage of each firm's total commercial fishing revenue derived from inside the NCSMNM addition area (Figure \ref{fig:percent_of_revenue_by_firm}).  Only small firms with revenue from the area are included in the plots; these plots are companions to Table \ref{tab:AnyInside}.  The area inside the boxes of indicate capture the 25$^th$-75$^th$ percentiles, indicating that,  after excluding firms that do not use the NCSMNM addition area, most firms derive a small proportion of their total revenue from the NCSMNM addition area. 

```{r percent_of_revenue_by_firm, eval = T, fig.cap="\\label{fig:percent_of_revenue_by_firm} Annual firm revenue percentage boxplots, only small firms with some activity inside NCSMNM Addition"}  

# create new folder for section
dir.create(file.path(output_f, "firm"), showWarnings = FALSE)
output_ffirm = file.path(output_f, "firm")


#Join the affiliate Keyfile to the REVENUEFILE
PermitInsideRev <- aff_key %>%
  inner_join(REVENUEFILE, by=c("permit"="PERMIT")) %>%
  group_by(affiliate_id, Size, Year, Area) %>%
  summarize(InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    AllREV = sum(REVENUE,na.rm=T)) %>%
    filter(Area != "Other") %>%
    filter(InsideREV >0 ) %>%
    filter(Size=="Small") %>%
  mutate(Percent=100*InsideREV/AllREV,
         Year=as.character(Year)) %>%
  arrange(desc(InsideREV))

Totals <- PermitInsideRev %>%
  group_by(affiliate_id, Size, Area) %>%
  summarize(InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    AllREV = sum(AllREV,na.rm=T)) %>%
    filter(Area != "Other") %>%
  mutate(Percent=100*InsideREV/AllREV,
         Year="Total") %>%
  arrange(desc(InsideREV))

PermitInsideRev<- rbind(PermitInsideRev,Totals)


# iterate over all areas and produce box plot
for (z in unique(PermitInsideRev$Area)) {
  Permitboxplot <- PermitInsideRev %>% filter(Area==z)
  broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", z)), perl=TRUE)
### ggplot version ###
  # par(family = "serif")
  # windowsFonts(Times=windowsFont("Times New Roman"))
  boxplot <- ggplot(data = Permitboxplot, aes(x = Year, y = Percent, fill=Year)) +
  geom_boxplot(linetype = "dashed", outlier.shape = 1) +
  stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = 1) +
  stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..)) +
  stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..)) +
  # scale_y_continuous(breaks = seq(4.5, 8.0, 0.5)) +
  scale_fill_viridis(discrete=TRUE) +
  coord_flip() +
  labs(x = NULL,
       y = "Percent Total Revenue inside the NCSMNM Addition by Firm") +
   scale_y_continuous(breaks=seq(0,80,10))+
  theme_bw() +
  # theme_classic() + # remove panel background and gridlines
  # theme(text=element_text(family="serif"),
  theme(text=element_text(size=10),
        legend.position="none", plot.title = element_text(hjust = 0.5,size = 14), # hjust = 0.5 centers the title
        panel.border = element_rect(linetype = "solid",
                                    colour = "black", 
                                    fill = "NA", 
                                    size = 0.5))
  
plot(boxplot)
# save to file
ggsave(file.path(output_ffirm, paste0("boxplot_firmsPct_",z,".png")), plot = boxplot)
rm(boxplot)
}

```

Similarly, box-whisker plots of firm's total commercial fishing revenue derived from inside the NCSMNM addition area (Figure \ref{fig:revenue_by_firmAA}) illustrate that most of the firms earn less than \$30,000 in gross receipts from the NCSMNM addition.

```{r rev_by_firm, asis=TRUE, eval = T, fig.cap="\\label{fig:revenue_by_firmAA} Annual firm revenue percentage boxplots, only small firms with some activity inside NCSMNM Addition"}  

num_years<-length(unique(PermitInsideRev[PermitInsideRev$Year!="Total",]$Year))

# iterate over all areas and produce box plot
for (z in unique(PermitInsideRev$Area)) {
  Permitboxplot <- PermitInsideRev %>%
    filter(Area==z) %>%
    filter(Size=="Small") %>%
    mutate(InsideREV=InsideREV/1000) %>%
    mutate(Year = ifelse(Year == "Total", "Average", Year)) %>%
    mutate(InsideREV = ifelse(Year=="Average",  InsideREV/num_years, InsideREV))
    broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", z)), perl=TRUE)
### ggplot version ###
  # par(family = "serif")
  # windowsFonts(Times=windowsFont("Times New Roman"))
  boxplot <- ggplot(data = Permitboxplot, aes(x = Year, y = InsideREV, fill=Year) ) +
  geom_boxplot(linetype = "dashed", outlier.shape = NA) +
  stat_boxplot(outlier.shape = NA) +
  stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..)) +
  stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..)) +
  scale_fill_viridis(discrete=TRUE) +
  coord_flip() +
  scale_y_continuous(limits=c(0,60), breaks=seq(0,60,10))+
  labs(x = NULL,
       y = "Annual Revenue ('000s) Inside the NCSMNM Addition by Firm") +
  theme_bw() +
  # theme_classic() + # remove panel background and gridlines
  # theme(text=element_text(family="serif"),
  theme(text=element_text(size=10),
        legend.position="none", plot.title = element_text(hjust = 0.5,size = 14), # hjust = 0.5 centers the title
        panel.border = element_rect(linetype = "solid",
                                    colour = "black", 
                                    fill = "NA", 
                                    size = 0.5))
plot(boxplot)
# save to file
ggsave(file.path(output_ffirm, paste0("boxplot_firmsRev_",z,".png")), plot = boxplot)
rm(boxplot)
}
```
\addtocounter{figure}{+1} <!----The previous figure is not getting captioned properly. I will add to the figure counter and hack it later.  ---->

Figure \ref{fig:REV_PCT_scatter} plots average annual revenue against the percentage of revenue derived from the NCSMNM addition.  This illustrates that a few firms use the NCSMNM addition for more than 50\% of their gross revenues, but these firms have relatively low gross receipts.  A few firms derive more than $75,000 of revenue from NCSMNM, but these firms earn a low proportion of their total revenue from this area.    


```{r Rev_and_Pct_scatter,eval = T, fig.cap="\\label{fig:REV_PCT_scatter} Scatterplot of percentage of small firm revenue inside NCSMNM against annual firm revenue inside NCSMNM, only firms with some activity inside NCSMNM Addition."}

num_years<-length(unique(PermitInsideRev[PermitInsideRev$Year!="Total",]$Year))


PCT_Scatter<-PermitInsideRev %>%
  filter(Year=="Total" & Size=="Small") %>%
  mutate(
    InsideREV=InsideREV/num_years/1000,
    InsideLANDED=InsideLANDED/num_years,
    AllREV=AllREV/num_years/1000
  ) %>%
  filter(AllREV<=1000)

ggplot(PCT_Scatter, aes(x=AllREV, y=Percent)) +
  geom_point() + 
  labs(x = "Average Annual ('000s) Revenue, all areas",
       y = "Percentage of Firm Revenue Inside NCSMNM")+
  scale_y_continuous(limits=c(0,100), breaks=seq(0,100,20))+
 scale_x_continuous(limits=c(0,1000), breaks=seq(0,1000,200))

rm(PCT_Scatter)
```

```{r count_years, fig.cap="\\label{fig:nyears} Histogram of the number of years that small firms were active in the NCSMNM addition. "}
count_years<-PermitInsideRev %>%
  filter(Year!="Total" & Size=="Small") %>%
  group_by(affiliate_id,Size) %>%
  count()
distinct_firms<-length(unique(count_years$affiliate_id))

#table(count_years$n)

ggplot(count_years, aes(x=n)) + 
  geom_histogram( binwidth=1, fill="gray", color="gray", alpha=0.9) +
  labs(x = "Number of Years (2012-2016) fished in NCSMNM Addition" ,
       y = "Number of Small Firms Active in NCSMNM Addition")  


```

The NCSMNM addition was not used by every firm in every year. Table \ref{tab:AnyInside} shows that 80-110 firms used the NCSMNM addition each year.  There were `r distinct_firms` that fished in the NCSMNM addition at any point over the 2012-2016 time period.  Many firms did not fish in this area in all years.  Figure \ref{fig:nyears} is a histogram of the number of years each firm fished inside the NCSMNM addition. Almost 60 firms fished there for just 1 year while 33 fished there in all five years.

Together, these tables and figures illustrate that:

1.  Less than 100 small fishing firms (under 10\% of the small firms in the Northeast US) use the NCSMNM addition area  (Tables \ref{tab:Firm_average_in_Area} and \ref{tab:AnyInside}).
2.  Small and Large firms that do use the NCSMNM addition derive only a small proportion of their revenue from the NCSMNM addition (Table \ref{tab:AnyInside}). 
3.  As a percentage of gross receipts, small firms derive slightly more revenue that large firms from NCSMNM  (Table \ref{tab:AnyInside}).
4.  A handful of small firms use the NCSMNM addition for moderate amount of their fishing (Figure \ref{fig:percent_of_revenue_by_firm}).
5.  However, the firms that do derive more than 20\% of their gross receipts from the NCSMNM addition are quite small in size (Figure \ref{fig:REV_PCT_scatter}).

### Compliance Requirements
A description of the projected reporting, record-keeping, and other compliance requirements of the proposed rule, including an estimate of the classes of small entities which will be subject to the requirements of the report or record.

### Duplications
An identification, to the extent practicable, of all relevant Federal rules, which may duplicate, overlap, or conflict with the proposed rule.

First, we note that commerical fishing (excepting red crab fishing) is currently prohibited in 82\% of the NCSMNM.  Therefore, the proposed rule somewhat overlaps with the current fishing regulations. 

Second, we note that fishing NCSMNM is currently prohibited by Presidential Proclamation via the Antiquities Act. Proclamations 9496 and 10287 did not contain implementing rules or regulations, but directed the Secretaries of Interior and Commerce to develop them. The proposed rule does precisely that. 

\newpage

# References
<div id="refs"></div>
